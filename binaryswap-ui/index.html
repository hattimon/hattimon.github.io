<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BinarySwap</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.8.1/dist/ethers.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f0f2f5; }
    h2 { color: #333; }
    button { margin: 5px; padding: 10px 15px; cursor: pointer; }
    input { padding: 8px; margin: 5px; }
    .section { border: 1px solid #ccc; padding: 15px; margin-top: 20px; background: white; border-radius: 10px; }
  </style>
</head>
<body>
  <h2>BinarySwap</h2>

  <div class="section">
    <p>Status portfela: <span id="wallet-status">Niepołączony</span></p>
    <button onclick="connectWallet()">Połącz z MetaMask</button>
    <button onclick="addOpBNBNetwork()">Dodaj sieć opBNB</button>
  </div>

  <div class="section">
    <h3>Twoje tokeny</h3>
    <p>0101: <span id="bal0101">?</span></p>
    <p>BNB: <span id="balBNB">?</span></p>
    <p>LP UNI-V2: <span id="balLP">?</span></p>
  </div>

  <div class="section">
    <h3>Swap</h3>
    <input type="text" id="swapAmount" placeholder="Ilość do swapu">
    <button onclick="swap0101ToBNB()">Swap 0101 → BNB</button>
    <button onclick="swapBNBTo0101()">Swap BNB → 0101</button>
  </div>

  <div class="section">
    <h3>Dodaj / Usuń LP</h3>
    <input type="text" id="removeLPAmount" placeholder="Ilość LP">
    <button onclick="removeLiquidity(true)">Usuń LP</button>
    <button onclick="removeLiquidity(false)">Usuń Max LP</button>
  </div>

  <div class="section">
    <h3>MasterChef</h3>
    <input type="text" id="pid" placeholder="ID Puli">
    <button onclick="getPendingCub()">Pobierz Pending Cub</button>
    <p>Pending CUB: <span id="pendingCub">?</span></p>
    <button onclick="emergencyWithdraw()">Emergency Withdraw</button>
  </div>

  <script>
    const token0101 = "0xa41B3067eC694DBec668c389550bA8fc589e5797";
    const lpToken = "0x506b8322e1159d06e493ebe7ffa41a24291e7ae3";
    const routerAddr = "0x3958795ca5C4d9f7Eb55656Ba664efA032E1357b";
    const masterChefAddr = "0x39a786421889EB581bd105508a0D2Dc03523B903";

    const provider = new ethers.BrowserProvider(window.ethereum);
    let signer, userAddr;

    const erc20ABI = [
      "function balanceOf(address owner) view returns (uint256)",
      "function approve(address spender, uint256 amount) returns (bool)",
      "function decimals() view returns (uint8)"
    ];

    const routerABI = [
      "function swapExactTokensForETH(uint amountIn, uint amountOutMin, address[] calldata path, address to, uint deadline) returns (uint[] memory amounts)",
      "function swapExactETHForTokens(uint amountOutMin, address[] calldata path, address to, uint deadline) payable returns (uint[] memory amounts)",
      "function removeLiquidityETH(address token, uint liquidity, uint amountTokenMin, uint amountETHMin, address to, uint deadline) returns (uint amountToken, uint amountETH)"
    ];

    const masterChefABI = [
      "function pendingCub(uint256,address) view returns (uint256)",
      "function emergencyWithdraw(uint256)"
    ];

    async function connectWallet() {
      const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
      signer = await provider.getSigner();
      userAddr = accounts[0];
      document.getElementById("wallet-status").textContent = userAddr;
      getBalances();
    }

    async function addOpBNBNetwork() {
      await window.ethereum.request({ method: 'wallet_addEthereumChain', params: [{
        chainId: '0xcc',
        chainName: 'OpBNB Mainnet',
        rpcUrls: ['https://opbnb-mainnet-rpc.bnbchain.org/'],
        nativeCurrency: { name: 'BNB', symbol: 'BNB', decimals: 18 },
        blockExplorerUrls: ['https://mainnet.opbnbscan.com/']
      }]});
    }

    async function getBalances() {
      const token = new ethers.Contract(token0101, erc20ABI, provider);
      const lp = new ethers.Contract(lpToken, erc20ABI, provider);
      const bnb = await provider.getBalance(userAddr);

      const bal0101 = await token.balanceOf(userAddr);
      const balLP = await lp.balanceOf(userAddr);

      document.getElementById("bal0101").textContent = ethers.formatUnits(bal0101, 18);
      document.getElementById("balBNB").textContent = ethers.formatEther(bnb);
      document.getElementById("balLP").textContent = ethers.formatUnits(balLP, 18);
    }

    async function swap0101ToBNB() {
      const router = new ethers.Contract(routerAddr, routerABI, signer);
      const token = new ethers.Contract(token0101, erc20ABI, signer);
      const amount = ethers.parseUnits(document.getElementById("swapAmount").value, 18);
      const path = [token0101, "0x4200000000000000000000000000000000000006"];

      await token.approve(routerAddr, amount);
      const tx = await router.swapExactTokensForETH(
        amount, 0, path, userAddr, Math.floor(Date.now() / 1000) + 600
      );
      await tx.wait();
      getBalances();
    }

    async function swapBNBTo0101() {
      const router = new ethers.Contract(routerAddr, routerABI, signer);
      const amount = ethers.parseEther(document.getElementById("swapAmount").value);
      const path = ["0x4200000000000000000000000000000000000006", token0101];

      const tx = await router.swapExactETHForTokens(
        0, path, userAddr, Math.floor(Date.now() / 1000) + 600, { value: amount }
      );
      await tx.wait();
      getBalances();
    }

    async function removeLiquidity(useInput) {
      const lp = new ethers.Contract(lpToken, erc20ABI, signer);
      const router = new ethers.Contract(routerAddr, routerABI, signer);
      let amount = await lp.balanceOf(userAddr);
      if (useInput) {
        const val = document.getElementById("removeLPAmount").value;
        if (val) amount = ethers.parseUnits(val, 18);
      }
      await lp.approve(routerAddr, amount);
      const tx = await router.removeLiquidityETH(token0101, amount, 0, 0, userAddr, Math.floor(Date.now() / 1000) + 600);
      await tx.wait();
      getBalances();
    }

    async function getPendingCub() {
      const pid = document.getElementById("pid").value;
      const mc = new ethers.Contract(masterChefAddr, masterChefABI, provider);
      const pending = await mc.pendingCub(pid, userAddr);
      document.getElementById("pendingCub").textContent = ethers.formatUnits(pending, 18);
    }

    async function emergencyWithdraw() {
      const pid = document.getElementById("pid").value;
      const mc = new ethers.Contract(masterChefAddr, masterChefABI, signer);
      const tx = await mc.emergencyWithdraw(pid);
      await tx.wait();
      getBalances();
    }
  </script>
</body>
</html>
