<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BinarySwap</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.8.1/dist/ethers.umd.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <style>
    :root { --bg-color:#1d1d1d; --text-color:#1db954; --card-bg:#2a2a2a; --button-bg:#3a3a3a; --link-color:#a0ffcc; }
    [data-theme="light"] { --bg-color:#fff; --text-color:#000; --card-bg:#f0f0f0; --button-bg:#e0e0e0; --link-color:#007acc; }
    body { margin:0;padding:20px;font-family:Arial; background:var(--bg-color); color:var(--text-color); transition:0.3s; }
    a { color:var(--link-color); text-decoration:none; }
    button { margin:5px;padding:10px 15px; border:none; border-radius:5px; background:var(--button-bg); color:var(--text-color);
              cursor:pointer; display:inline-flex; align-items:center; gap:8px; }
    input, select { margin:5px; padding:8px; border-radius:5px; border:1px solid #555; background:var(--card-bg); color:var(--text-color); }
    .section { margin-top:20px; padding:15px; border:1px solid #444; border-radius:10px; background:var(--card-bg); }
    #logo { max-width:500px; display:block; margin:0 auto; }
    .top-links { text-align:center; margin-bottom:20px; }
    .theme-toggle { position:fixed; top:10px; right:10px; padding:8px 12px; border-radius:5px; z-index:1000; }
    .center-title { text-align:center; font-size:24px; margin-top:10px; }
  </style>
</head>
<body>
  <img id="logo" src="https://binaryswap.gitbook.io/binaryswap/~gitbook/image?url=https%3A%2F%2F2482429338-files.gitbook.io%2F..." alt="BinarySwap logo">
  <div class="top-links"><a href="https://binaryswap.gitbook.io/binaryswap" target="_blank">ðŸ“˜ Dokumentacja BinarySwap</a></div>
  <button class="theme-toggle" onclick="toggleTheme()">ðŸŒž Tryb jasny</button>
  <div class="center-title">Tryb Awaryjny BinarySwap</div>

  <div id="app-root">
    <div class="section">
      <p><strong>Portfel:</strong> <span id="wallet-address">NiepoÅ‚Ä…czony</span></p>
      <button onclick="connectWallet()"><i class="fab fa-ethereum"></i> PoÅ‚Ä…cz MetaMask</button>
      <button onclick="addNetwork()"><i class="fas fa-network-wired"></i> PrzeÅ‚Ä…cz na opBNB</button>
    </div>

    <div class="section">
      <p>0101: <span id="balance-0101">â€“</span></p>
      <p>BNB: <span id="balance-bnb">â€“</span></p>
      <p>LP (0101/BNB): <span id="balance-lp">â€“</span></p>
    </div>

    <div class="section">
      <h3>Swap</h3>
      <input type="number" id="swapPercent" placeholder="% z portfela (1â€“100)">
      <select id="swapDirection">
        <option value="toToken">BNB â†’ 0101</option>
        <option value="toBNB">0101 â†’ BNB</option>
      </select>
      <select id="swapSlippage">
        <option>1%</option><option>3%</option><option>5%</option>
      </select>
      <button onclick="handleSwap()"><i class="fas fa-exchange-alt"></i> Swap</button>
    </div>

    <div class="section">
      <h3>Pula PÅ‚ynnoÅ›ci</h3>
      <input type="number" id="lpPercent" placeholder="% z portfela (1â€“100)">
      <button onclick="addLiquidity(parseInt(lpPercent.value))"><i class="fas fa-plus-circle"></i> Dodaj LP</button>
      <button onclick="removeLiquidity(parseInt(lpPercent.value))"><i class="fas fa-minus-circle"></i> UsuÅ„ LP</button>
    </div>

    <div class="section" id="lp-info">
      <h3>MasterChef â€“ Twoje pule</h3>
      <!-- dynamicznie wygenerowane -->
    </div>
  </div>

<script>
// --- Konfiguracja ---
let provider, signer, account;
const token0101Addr = "0xa41b3067ec694dbec668c389550ba8fc589e5797";
const lpTokenAddr =    "0x506b8322e1159d06e493ebe7ffa41a24291e7ae3";
const routerAddr =     "0x3958795ca5C4d9f7Eb55656Ba664efA032E1357b";
const masterChefAddr = "0x39a786421889EB581bd105508a0D2Dc03523B903";

// ABI minimalne
const ERC20 = [
  "function balanceOf(address owner) view returns (uint256)",
  "function approve(address spender, uint256 value) returns(bool)"
];
const ROUTER = [
  "function addLiquidityETH(address,uint,uint,uint,address,uint) payable returns(uint,uint,uint)",
  "function removeLiquidityETH(address,uint,uint,uint,address,uint) returns(uint,uint)",
  "function swapExactETHForTokensSupportingFeeOnTransferTokens(uint,address[],address,uint) payable",
  "function swapExactTokensForETHSupportingFeeOnTransferTokens(uint,uint,address[],address,uint)"
];
const MASTER = [
  "function poolLength() view returns(uint256)",
  "function userInfo(uint256,address) view returns(uint256,uint256)",
  "function pendingCub(uint256,address) view returns(uint256)",
  "function emergencyWithdraw(uint256)"
];

// --- Tryb ---
function toggleTheme(){
  const html = document.documentElement;
  const light = html.getAttribute("data-theme")==="light";
  html.setAttribute("data-theme", light? "": "light");
  document.querySelector('.theme-toggle').textContent = light? "ðŸŒž Tryb jasny" : "ðŸŒ™ Tryb ciemny";
  localStorage.theme = light ? "" : "light";
}
(function(){
  const pref = localStorage.theme === "light" ? "light": "";
  document.documentElement.setAttribute("data-theme", pref);
  document.querySelector('.theme-toggle').textContent = pref? "ðŸŒ™ Tryb ciemny":"ðŸŒž Tryb jasny";
})();

// --- Portfel + salda ---
async function connectWallet(){
  if(!window.ethereum) return alert("Zainstaluj MetaMask!");
  provider = new ethers.BrowserProvider(window.ethereum);
  await provider.send("eth_requestAccounts",[]);
  signer = await provider.getSigner();
  account = await signer.getAddress();
  document.getElementById("wallet-address").textContent = account;
  updateBalances();
  fetchLPInfo();
}

async function updateBalances(){
  const t = new ethers.Contract(token0101Addr, ERC20, provider);
  const l = new ethers.Contract(lpTokenAddr, ERC20, provider);
  const [b0101, bLP, bBNB] = await Promise.all([
    t.balanceOf(account),
    l.balanceOf(account),
    provider.getBalance(account)
  ]);
  document.getElementById("balance-0101").textContent = parseFloat(ethers.formatUnits(b0101,18)).toFixed(8);
  document.getElementById("balance-bnb").textContent = parseFloat(ethers.formatUnits(bBNB,18)).toFixed(8);
  document.getElementById("balance-lp").textContent = parseFloat(ethers.formatUnits(bLP,18)).toFixed(8);
}

// --- SieÄ‡ opBNB ---
async function addNetwork(){
  try{
    await window.ethereum.request({
      method:"wallet_addEthereumChain",
      params:[{
        chainId:"0xcc", chainName:"opBNB Mainnet",
        nativeCurrency:{name:"BNB",symbol:"BNB",decimals:18},
        rpcUrls:["https://opbnb-mainnet-rpc.bnbchain.org/"],
        blockExplorerUrls:["https://mainnet.opbnbscan.com/"]
      }]
    });
  }catch(e){ alert("BÅ‚Ä…d dodania sieci: "+e.message); }
}

// --- Swap ---
async function handleSwap(){
  const pc = parseInt(swapPercent.value);
  if(isNaN(pc)||pc<1||pc>100) return alert("Procent musi byÄ‡ 1â€“100!");
  const sl = parseInt(swapSlippage.value);
  swapDirection.value==="toToken"? swapBNBto0101(pc,sl): swap0101toBNB(pc,sl);
}

async function swapBNBto0101(pc, sl){
  const r = new ethers.Contract(routerAddr, ROUTER, signer);
  const bal = await provider.getBalance(account);
  const val = bal * BigInt(pc)/100n;
  const path = ["0x4200000000000000000000000000000000000006", token0101Addr];
  await r.swapExactETHForTokensSupportingFeeOnTransferTokens(0, path, account, Math.floor(Date.now()/1e3)+600, { value: val });
  await updateBalances();
}

async function swap0101toBNB(pc, sl){
  const t = new ethers.Contract(token0101Addr,ERC20,signer);
  const r = new ethers.Contract(routerAddr,ROUTER,signer);
  const bal = await t.balanceOf(account);
  const val = bal * BigInt(pc)/100n;
  await t.approve(routerAddr,val);
  const path = [token0101Addr,"0x4200000000000000000000000000000000000006"];
  await r.swapExactTokensForETHSupportingFeeOnTransferTokens(val,0,path,account,Math.floor(Date.now()/1e3)+600);
  await updateBalances();
}

// --- LP ---
async function addLiquidity(pc){
  const t = new ethers.Contract(token0101Addr,ERC20,signer);
  const r = new ethers.Contract(routerAddr,ROUTER,signer);
  const bB = await provider.getBalance(account);
  const bT = await t.balanceOf(account);
  const vB = bB * BigInt(pc)/100n;
  const vT = bT * BigInt(pc)/100n;
  await t.approve(routerAddr,vT);
  await r.addLiquidityETH(token0101Addr,vT,0,0,account,Math.floor(Date.now()/1e3)+600, { value: vB });
  await updateBalances();
}

async function removeLiquidity(pc){
  const l = new ethers.Contract(lpTokenAddr,ERC20,signer);
  const r = new ethers.Contract(routerAddr,ROUTER,signer);
  const bL = await l.balanceOf(account);
  const vL = bL * BigInt(pc)/100n;
  await l.approve(routerAddr,vL);
  await r.removeLiquidityETH(token0101Addr,vL,0,0,account,Math.floor(Date.now()/1e3)+600);
  await updateBalances();
}

// --- MasterChef EmergencyWithdraw ---
async function fetchLPInfo(){
  const m = new ethers.Contract(masterChefAddr, MASTER, provider);
  const len = parseInt(await m.poolLength());
  lp-info.innerHTML="";
  for(let i=0;i<len;i++){
    const ui = await m.userInfo(i, account);
    const pd = await m.pendingCub(i, account);
    if(ui[0]>0n || pd>0n){
      const p = document.createElement("p");
      p.innerHTML = `Pool ${i}: LP=${parseFloat(ethers.formatUnits(ui[0],18)).toFixed(8)}, Pending CUB=${parseFloat(ethers.formatUnits(pd,18)).toFixed(8)} <button onclick="emergencyWithdraw(${i})">ðŸš¨</button>`;
      document.getElementById("lp-info").append(p);
    }
  }
}

async function emergencyWithdraw(i){
  const m = new ethers.Contract(masterChefAddr, MASTER, signer);
  await m.emergencyWithdraw(i);
  await fetchLPInfo();
  await updateBalances();
}

</script>

</body></html>
