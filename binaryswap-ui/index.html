<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BinarySwap</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.8.1/dist/ethers.umd.min.js"></script>
  <style>
    body { font-family: sans-serif; max-width: 700px; margin: auto; padding: 2rem; }
    button, input { margin: 0.5rem 0; padding: 0.5rem; width: 100%; }
    section { margin-bottom: 2rem; border-bottom: 1px solid #ccc; padding-bottom: 1rem; }
  </style>
</head>
<body>
  <h1>BinarySwap - Swap, Add/Remove LP, MasterChef</h1>

  <section>
    <h2>Portfel</h2>
    <button onclick="connectWallet()">Połącz z MetaMask</button>
    <p id="walletAddress">Portfel odłączony</p>
    <button onclick="addOpBNBNetwork()">Dodaj sieć opBNB</button>
  </section>

  <section>
    <h2>Informacje o Puli (MasterChef)</h2>
    <input type="number" id="poolId" placeholder="Wpisz Pool ID">
    <button onclick="loadPoolData()">Pobierz dane o puli</button>
    <pre id="poolData"></pre>
    <button onclick="emergencyWithdraw()">Emergency Withdraw</button>
  </section>

  <section>
    <h2>Dodaj LP</h2>
    <input type="text" id="amountTokenA" placeholder="Ilość tokena 0101">
    <input type="text" id="amountBNB" placeholder="Ilość BNB">
    <button onclick="addLiquidity()">Dodaj LP</button>
  </section>

  <section>
    <h2>Usuń LP</h2>
    <button onclick="removeLiquidity()">Usuń LP</button>
  </section>

  <section>
    <h2>Swap Token 0101 → BNB</h2>
    <button onclick="swapTokenToBNB()">Wykonaj swap</button>
  </section>

  <script>
    const provider = new ethers.BrowserProvider(window.ethereum);
    let signer, address;

    const tokenA = "0xa41b3067ec694dbec668c389550ba8fc589e5797"; // 0101
    const wbnb = "0x4200000000000000000000000000000000000006";
    const lpToken = "0x506b8322e1159d06e493ebe7ffa41a24291e7ae3";
    const routerAddr = "0x3958795ca5C4d9f7Eb55656Ba664efA032E1357b";
    const masterChef = "0x39a786421889EB581bd105508a0D2Dc03523B903";

    const tokenAbi = ["function approve(address spender, uint256 amount) returns (bool)", "function balanceOf(address) view returns (uint256)", "function decimals() view returns (uint8)"];
    const lpAbi = ["function balanceOf(address) view returns (uint256)", "function approve(address spender, uint256 amount) returns (bool)"];
    const routerAbi = [
      "function addLiquidityETH(address token,uint amountTokenDesired,uint amountTokenMin,uint amountETHMin,address to,uint deadline) payable returns (uint amountToken, uint amountETH, uint liquidity)",
      "function removeLiquidityETH(address token,uint liquidity,uint amountTokenMin,uint amountETHMin,address to,uint deadline) returns (uint amountToken, uint amountETH)",
      "function swapExactTokensForETH(uint amountIn,uint amountOutMin,address[] calldata path,address to,uint deadline) returns (uint[] memory amounts)",
      "function getAmountsOut(uint amountIn, address[] calldata path) view returns (uint[] memory amounts)"
    ];
    const masterChefAbi = [
      "function emergencyWithdraw(uint pid)",
      "function pendingCub(uint pid, address user) view returns (uint)",
      "function userInfo(uint pid, address user) view returns (uint amount, uint rewardDebt)",
      "function poolInfo(uint pid) view returns (address lpToken, uint allocPoint, uint lastRewardBlock, uint accCubPerShare, uint depositFeeBP)"
    ];

    async function connectWallet() {
      await provider.send("eth_requestAccounts", []);
      signer = await provider.getSigner();
      address = await signer.getAddress();
      document.getElementById("walletAddress").textContent = `Połączono: ${address}`;
    }

    async function addOpBNBNetwork() {
      try {
        await window.ethereum.request({
          method: "wallet_addEthereumChain",
          params: [{
            chainId: "0xcc",
            chainName: "opBNB Mainnet",
            rpcUrls: ["https://opbnb-mainnet-rpc.bnbchain.org/"],
            nativeCurrency: { name: "BNB", symbol: "BNB", decimals: 18 },
            blockExplorerUrls: ["https://mainnet.opbnbscan.com/"]
          }]
        });
        alert("Sieć opBNB dodana");
      } catch (e) {
        alert("Błąd przy dodawaniu sieci: " + e.message);
      }
    }

    async function loadPoolData() {
      const pid = document.getElementById("poolId").value;
      const contract = new ethers.Contract(masterChef, masterChefAbi, provider);
      const [pending, user, pool] = await Promise.all([
        contract.pendingCub(pid, address),
        contract.userInfo(pid, address),
        contract.poolInfo(pid)
      ]);
      document.getElementById("poolData").textContent =
        `Pending Cub: ${ethers.formatUnits(pending, 18)}\n` +
        `User amount: ${ethers.formatUnits(user.amount, 18)}\nReward debt: ${ethers.formatUnits(user.rewardDebt, 18)}\n` +
        `LP token: ${pool.lpToken}\nFee: ${pool.depositFeeBP}bps`;
    }

    async function emergencyWithdraw() {
      const pid = document.getElementById("poolId").value;
      const contract = new ethers.Contract(masterChef, masterChefAbi, signer);
      const tx = await contract.emergencyWithdraw(pid);
      alert("TX hash: " + tx.hash);
    }

    async function addLiquidity() {
      const token = new ethers.Contract(tokenA, tokenAbi, signer);
      const router = new ethers.Contract(routerAddr, routerAbi, signer);
      const amountToken = ethers.parseUnits(document.getElementById("amountTokenA").value, 18);
      const amountBNB = ethers.parseUnits(document.getElementById("amountBNB").value, 18);
      await token.approve(routerAddr, amountToken);
      const deadline = BigInt(Math.floor(Date.now() / 1000) + 600);
      const tx = await router.addLiquidityETH(tokenA, amountToken, 0, 0, address, deadline, { value: amountBNB });
      alert("Dodano LP: " + tx.hash);
    }

    async function removeLiquidity() {
      const lp = new ethers.Contract(lpToken, lpAbi, signer);
      const router = new ethers.Contract(routerAddr, routerAbi, signer);
      const balance = await lp.balanceOf(address);
      await lp.approve(routerAddr, balance);
      const deadline = BigInt(Math.floor(Date.now() / 1000) + 600);
      const tx = await router.removeLiquidityETH(tokenA, balance, 0, 0, address, deadline);
      alert("Usunięto LP: " + tx.hash);
    }

    async function swapTokenToBNB() {
      const token = new ethers.Contract(tokenA, tokenAbi, signer);
      const router = new ethers.Contract(routerAddr, routerAbi, signer);
      const balance = await token.balanceOf(address);
      await token.approve(routerAddr, balance);
      const path = [tokenA, wbnb];
      const amounts = await router.getAmountsOut(balance, path);
      const deadline = BigInt(Math.floor(Date.now() / 1000) + 600);
      const tx = await router.swapExactTokensForETH(balance, amounts[1] * 95n / 100n, path, address, deadline);
      alert("Swap zakończony: " + tx.hash);
    }
  </script>
</body>
</html>
