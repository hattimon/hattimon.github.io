<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>BUKA w Dolinie Muminków</title>
<style>
  :root{
    --cell: 32px; --cols: 25; --rows: 18;
    --bg:#0b1c10; --path:#0f2a18; --wall:#23402a;
    --tree:#2d5b33; --cap:#d3222a; --stem:#eddcc8;
    --buka:#7ad1ff; --hunter:#7de6a9; --text:#e6ffe6;
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial,sans-serif}
  .wrap{min-height:100%;display:grid;place-items:center;gap:10px;padding:10px}
  h1{margin:6px 0 2px;font-size:20px}
  .hud{display:grid;grid-template-columns:1fr;gap:6px;align-items:center;min-width:820px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .badge{background:#173a24;border:1px solid #2a5b3c;padding:6px 10px;border-radius:8px}
  .meter{position:relative;flex:1;min-width:260px;height:16px;background:#113621;border:1px solid #2a5b3c;border-radius:6px;overflow:hidden}
  .meter>.fill{position:absolute;inset:0;width:0%}
  .hp .fill{background:linear-gradient(90deg,#36d17c,#8fffd0)}
  .frost .fill{background:linear-gradient(90deg,#000,#333)}
  .cloudStock .fill{background:linear-gradient(90deg,#203848,#3b5c70)}
  .ammoAltBar .fill{background:linear-gradient(90deg,#85c6ff,#4190ff)}
  .grid{position:relative;width:calc(var(--cell)*var(--cols));height:calc(var(--cell)*var(--rows));background:var(--path);border-radius:10px;overflow:hidden;box-shadow:0 0 0 3px #163c25 inset,0 10px 30px rgba(0,0,0,.35)}
  canvas{width:100%;height:100%;image-rendering:pixelated}
  .controls{opacity:.9;font-size:14px}
  .controls kbd{background:#113621;border:1px solid #215035;border-bottom-width:3px;padding:2px 6px;border-radius:5px;font-family:ui-monospace,Menlo,monospace}
  .overlay{position:absolute;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.55);color:white;text-align:center;padding:24px;backdrop-filter:blur(2px)}
  .overlay[hidden]{display:none !important;pointer-events:none}
  .overlay .card{background:rgba(16,40,28,.9);border:1px solid #2a5b3c;border-radius:12px;padding:18px 20px;max-width:560px}
  button{background:#2a5b3c;color:white;border:0;padding:10px 14px;border-radius:8px;font-weight:700;cursor:pointer}
  button:hover{filter:brightness(1.1)}
  .mute{background:#20543a}
</style>
</head>
<body>
<div class="wrap">
  <h1>BUKA w Dolinie Muminków</h1>

  <div class="hud">
    <div class="row">
      <div class="badge">Cele: Muminki <span id="left">0</span> • Pioruny 5 • Chmurki 5 • Muchomory <span id="mushLeft">?</span></div>
      <div class="badge">Motyw: <span id="themeName">Las</span> • Pogoda: <span id="weatherName">Dzień</span></div>
    </div>
    <div class="row">
      <div class="badge">Punkty: <span id="score">0</span></div>
    </div>
    <div class="row">
      <div class="badge">Poziom: <span id="level">1</span>/10</div>
      <div class="badge">Zamrożenie Włóczykija: <span id="freezeT">0s</span></div>
      <div class="badge">Postęp: <span id="progress">0%</span></div>
    </div>
    <div class="row">
      <div class="badge">Amunicja Alt (Pioruny): <span id="ammoAltText">100</span></div>
      <div class="badge">Amunicja Spacja (Chmura): <span id="ammoCloudText">5</span></div>
    </div>
    <div class="row">
      <div class="meter frost" title="Czas trwania aktywnej chmury"><div id="frostFill" class="fill"></div></div>
    </div>
    <div class="row">
      <div class="meter cloudStock" title="Zapasy chmury (skala do 20)"><div id="cloudStockFill" class="fill"></div></div>
      <div class="meter ammoAltBar" title="Amunicja piorunów (skala do 100)"><div id="ammoAltFill" class="fill"></div></div>
    </div>
    <div class="row">
      <div class="meter hp" title="Życie"><div id="hpFill" class="fill"></div></div>
      <button id="musicBtn" class="mute">Muzyka: ON</button>
    </div>
    <div class="row controls">
      Sterowanie: <kbd>WASD</kbd>/<kbd>Strzałki</kbd> – ruch, <kbd>Spacja</kbd> – chmura, <kbd>Alt</kbd> – piorun, <kbd>P</kbd> – pauza, <kbd>R</kbd> – restart
    </div>
  </div>

  <div class="grid">
    <canvas id="game" width="800" height="576"></canvas>
    <div id="overlay" class="overlay">
      <div class="card">
        <div id="title" style="font-size:22px;margin-bottom:6px;">Buka budzi mróz…</div>
        <div id="desc" style="opacity:.9;margin-bottom:10px;">
          Zbieraj małe pioruny (+10 strzałów Alt) i małe chmurki (+5 użyć Spacji). Oboje pojawiają się co minutę (5 szt. na planszy). Zjedz wszystkie Muminki, aby przejść poziom. Włóczykij po 10 zamrożeniach znika, ale gra trwa dalej.
        </div>
        <button id="startBtn">Start</button>
      </div>
    </div>
  </div>
</div>

<audio id="musicHappy" loop preload="auto" src="magic-forest.mp3"></audio>
<audio id="musicDark" loop preload="auto" src="dark-ambient.mp3"></audio>

<script>
(() => {
  // Parametry bazowe
  const CELL=32, COLS=25, ROWS=18;
  const RNG_SEED=9001;

  const MIN_BOARD=Math.min(COLS*CELL, ROWS*CELL);
  const CLOUD_MAX_RADIUS=Math.floor(MIN_BOARD/5);

  const BOKA_BASE_SPEED=3.1, BOKA_R_BASE=14, HP_MAX=100;
  const HUNTER_R=11;
  const HUNTER_AIM_RANGE=360;

  // skalowanie trudności (10 poziomów)
  function diff(level){
    // 1..10
    const t=(level-1)/9;
    return {
      wallDensity: 0.26 + t*0.14,          // więcej ścian
      muminBase: 8 + Math.floor(level*1.2),
      hunterSpeed: 2.5 + t*1.2,
      hunterProjSpeed: 4.2 + t*1.4,
      fireCooldown: (1.8*5) * (1.0 - t*0.35), // trochę częściej na wyższych
      projDps: (14/10)*3, // 3× więcej niż poprzednio (twoje życzenie)
      weatherSeed: Math.random()
    }
  }

  // Motywy poziomów (kolory)
  const THEMES = [
    {name:'Las', bg:'#0b1c10', path:'#0f2a18', wall:'#23402a', accent:'#2d5b33'},
    {name:'Morze', bg:'#06202b', path:'#0b2c3a', wall:'#16495c', accent:'#2b7a8a'},
    {name:'Jesień', bg:'#1d1208', path:'#2a170b', wall:'#5a2e12', accent:'#7a4a1e'},
    {name:'Zima', bg:'#0a1520', path:'#0e1f30', wall:'#254a6b', accent:'#9ec9f0'},
    {name:'Wiosna', bg:'#0c1d12', path:'#12321c', wall:'#2f663d', accent:'#5cbf7a'},
    {name:'Noc', bg:'#05070e', path:'#0a1020', wall:'#1a2a4a', accent:'#3c5a8a'},
    {name:'Słonecznie', bg:'#13200d', path:'#1a2c12', wall:'#355a2a', accent:'#6bcf66'},
    {name:'Pochmurno', bg:'#0e1612', path:'#15211b', wall:'#2a4237', accent:'#6aa39a'},
    {name:'Mgła', bg:'#0a1614', path:'#0e1f1d', wall:'#1f3d3a', accent:'#8fd0cc'},
    {name:'Burza', bg:'#0a0d14', path:'#10182a', wall:'#233259', accent:'#6aa0ff'}
  ];
  function themeFor(level){ return THEMES[(level-1)%THEMES.length]; }

  // Pogoda (efekty)
  const WEATHERS = ['Dzień','Noc','Deszcz','Mgła','Słońce','Pochmurno'];
  function randomWeather(){ return WEATHERS[Math.floor(Math.random()*WEATHERS.length)]; }

  // DOM
  const canvas=document.getElementById('game'), ctx=canvas.getContext('2d');
  const overlay=document.getElementById('overlay'), startBtn=document.getElementById('startBtn');
  const leftEl=document.getElementById('left'), mushLeftEl=document.getElementById('mushLeft');
  const lvlEl=document.getElementById('level'), scoreEl=document.getElementById('score');
  const themeName=document.getElementById('themeName'), weatherName=document.getElementById('weatherName');
  const hpFill=document.getElementById('hpFill'), frostFill=document.getElementById('frostFill');
  const cloudStockFill=document.getElementById('cloudStockFill'), ammoAltFill=document.getElementById('ammoAltFill');
  const ammoAltText=document.getElementById('ammoAltText'), ammoCloudText=document.getElementById('ammoCloudText');
  const freezeT=document.getElementById('freezeT'), progressEl=document.getElementById('progress');
  const musicBtn=document.getElementById('musicBtn'), musicHappy=document.getElementById('musicHappy'), musicDark=document.getElementById('musicDark');

  // RNG
  function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return((t^t>>>14)>>>0)/4294967296}}
  let rng=mulberry32(RNG_SEED);
  function rr(a,b){return Math.floor(a+(b-a)*Math.random());}

  // Mapa i ozdoby
  let grid=[], trees=[], mushrooms=[];
  function isWall(c,r){if(r<0||c<0||r>=ROWS||c>=COLS)return true;return grid[r][c]===1}
  function genMap(level){
    const d=diff(level), th=themeFor(level);
    document.documentElement.style.setProperty('--bg', th.bg);
    document.documentElement.style.setProperty('--path', th.path);
    document.documentElement.style.setProperty('--wall', th.wall);
    trees=[]; mushrooms=[];
    grid=Array.from({length:ROWS},()=>Array(COLS).fill(0));
    for(let r=0;r<ROWS;r++)for(let c=0;c<COLS;c++) if(r===0||c===0||r===ROWS-1||c===COLS-1) grid[r][c]=1;
    for(let r=1;r<ROWS-1;r++) for(let c=1;c<COLS-1;c++) if(Math.random()<d.wallDensity) grid[r][c]=1;
    let snakes=8+Math.floor(level/2);
    while(snakes--){
      let r=(ROWS>>1)+rr(-3,3), c=(COLS>>1)+rr(-3,3);
      for(let i=0;i<200;i++){
        grid[r][c]=0;
        const dir=rr(0,4);
        if(dir===0&&r>1)r--; if(dir===1&&r<ROWS-2)r++;
        if(dir===2&&c>1)c--; if(dir===3&&c<COLS-2)c++;
      }
    }
    // domek 3x3
    let dr=0,dc=0;
    for(let tries=0;tries<200;tries++){
      const r=2+rr(0,ROWS-5), c=2+rr(0,COLS-5);
      let ok=true; for(let rr2=r;rr2<r+3;rr2++) for(let cc=c;cc<c+3;cc++) if(isWall(cc,rr2)) ok=false;
      if(ok){dr=r;dc=c;break;}
    }
    for(let rr2=dr;rr2<dr+3;rr2++) for(let cc=dc;cc<dc+3;cc++) grid[rr2][cc]=2;

    // drzewka/muchomory (w nie-morskich/zimowych i tak rysujemy – ale kolory wynikają z motywu)
    const treeCount=16+Math.floor(level*1.2);
    for(let i=0;i<treeCount;i++){
      const c=1+rr(0,COLS-2), r=1+rr(0,ROWS-2);
      if(grid[r][c]!==0) continue;
      const x=c*CELL+CELL/2, y=r*CELL+CELL/2;
      trees.push({x,y});
      if(Math.random()<0.28) mushrooms.push({x:x+rr(-8,9), y:y+rr(6,12), r:6, alive:true});
    }
  }
  function inHouse(x,y){const c=Math.floor(x/CELL), r=Math.floor(y/CELL); return grid[r] && grid[r][c]===2;}

  // Obiekty
  const boka={x:CELL*1.5,y:CELL*1.5,r:BOKA_R_BASE,hp:HP_MAX,poison:0,
              ammoAlt:100, ammoCloud:5, cloud:0, cloudActive:false, rooted:0, lookX:1, lookY:0, growT:0};
  const hunter={alive:true, x:CELL*(COLS-2.5), y:CELL*(ROWS-2.5), r:HUNTER_R, frozen:0, freezeHits:0, tShot:0};
  const mumins=[], fearClouds=[], blueClouds=[], projs=[], iceBolts=[];
  const crystals=[];          // stare kryształy – nie używamy ich już do amunicji
  const boltPickups=[];       // małe pioruny (5)
  const cloudPickups=[];      // małe chmurki (5)
  const pickupRespawn=60;     // 60 s respawn
  let boltTimers=[], cloudTimers=[];

  let level=1, score=0, playing=false, paused=false, musicOn=true, weather='Dzień';
  let lastTick=0;

  // Helpers
  function cellRect(c,r){return [c*CELL,r*CELL,CELL,CELL]}
  function dist(a,b,x,y){const dx=a-x,dy=b-y;return Math.hypot(dx,dy)}
  function moveCircle(obj,vx,vy,rad){
    let nx=obj.x+vx, ny=obj.y+vy;
    const minX=rad, minY=rad, maxX=COLS*CELL-rad, maxY=ROWS*CELL-rad;
    nx=Math.max(minX,Math.min(maxX,nx)); ny=Math.max(minY,Math.min(maxY,ny));
    const c=Math.floor(nx/CELL), r=Math.floor(ny/CELL);
    for(let rr2=r-1;rr2<=r+1;rr2++) for(let cc=c-1;cc<=c+1;cc++){
      if(!isWall(cc,rr2)) continue;
      const rx=cc*CELL, ry=rr2*CELL;
      const cx=Math.max(rx,Math.min(nx,rx+CELL));
      const cy=Math.max(ry,Math.min(ny,ry+CELL));
      const dx=nx-cx, dy=ny-cy, d2=dx*dx+dy*dy;
      if(d2<rad*rad-1){
        const d=Math.sqrt(Math.max(d2,1e-4));
        const ux=dx/d, uy=dy/d;
        nx=cx+ux*(rad+0.5); ny=cy+uy*(rad+0.5);
      }
    }
    return {x:nx,y:ny};
  }

  // Pickupy piorunów i chmurek
  function placePickups(arr,count,shape){
    arr.length=0;
    for(let i=0;i<count;i++){
      let x=0,y=0;
      for(let t=0;t<100;t++){
        const c=1+rr(0,COLS-2), r=1+rr(0,ROWS-2);
        if(grid[r][c]!==0) continue;
        x=c*CELL+CELL/2; y=r*CELL+CELL/2;
        break;
      }
      arr.push({x,y,r:10, alive:true, shape});
    }
  }
  function scheduleRespawns(timers, arr, shape){
    timers.length=arr.length;
    for(let i=0;i<arr.length;i++) timers[i]=0;
    return function indexCollected(idx){
      timers[idx]=pickupRespawn;
      arr[idx].alive=false;
    }
  }

  // Inicjalizacja poziomu
  function resetLevel(){
    const th=themeFor(level);
    const d=diff(level);
    genMap(level);
    mumins.length=0; fearClouds.length=0; blueClouds.length=0; projs.length=0; iceBolts.length=0;
    boltPickups.length=0; cloudPickups.length=0;

    boka.x=CELL*1.5; boka.y=CELL*1.5; boka.hp=HP_MAX; boka.poison=0; boka.cloud=0; boka.cloudActive=false; boka.rooted=0; boka.lookX=1; boka.lookY=0;
    hunter.alive=true; hunter.x=CELL*(COLS-2.5); hunter.y=CELL*(ROWS-2.5); hunter.frozen=0; hunter.freezeHits=0; hunter.tShot=0;

    // Muminki
    const toPlace=d.muminBase;
    for(let i=0;i<toPlace;i++){
      const c=1+rr(0,COLS-2), r=1+rr(0,ROWS-2);
      if(isWall(c,r)||grid[r][c]===2) {i--; continue;}
      const x=c*CELL+CELL/2, y=r*CELL+CELL/2;
      if(dist(x,y,boka.x,boka.y)<80){i--; continue;}
      mumins.push({x,y,r:11, alive:true, hide:false, frozen:0, dir:Math.random()*Math.PI*2});
    }

    // Pickupy: 5 piorunów i 5 chmurek (respawn co 60 s)
    placePickups(boltPickups,5,'bolt');
    placePickups(cloudPickups,5,'cloud');
    boltTimers=[]; cloudTimers=[];
    const onBoltCollected = scheduleRespawns(boltTimers, boltPickups, 'bolt');
    const onCloudCollected = scheduleRespawns(cloudTimers, cloudPickups, 'cloud');
    // zapamiętujemy funkcje
    boltPickups.onCollected=onBoltCollected;
    cloudPickups.onCollected=onCloudCollected;

    // HUD
    leftEl.textContent = mumins.filter(m=>m.alive).length;
    mushLeftEl.textContent = mushrooms.filter(m=>m.alive!==false).length;
    lvlEl.textContent = level;
    scoreEl.textContent = score;
    ammoAltText.textContent = boka.ammoAlt;
    ammoCloudText.textContent = boka.ammoCloud;
    cloudStockFill.style.width = Math.min(100, (boka.ammoCloud/20)*100) + '%';
    ammoAltFill.style.width = Math.min(100, (boka.ammoAlt/100)*100) + '%';
    hpFill.style.width = '100%';
    frostFill.style.width='0%';

    // Motyw i pogoda
    weather = randomWeather();
    themeName.textContent = th.name;
    weatherName.textContent = weather;
  }

  // Wejście
  const keys=new Set();
  window.addEventListener('keydown', (e)=>{
    const mv=['ArrowUp','ArrowDown','ArrowLeft','ArrowRight','KeyW','KeyA','KeyS','KeyD'];
    if(mv.includes(e.code)){ e.preventDefault(); keys.add(e.code); }
    if(e.code==='Space'){ e.preventDefault(); tryUseCloud(); }
    if(e.code==='AltLeft' || e.code==='AltRight'){ e.preventDefault(); fireIceBolt(); }
    if(e.code==='KeyP') paused=!paused;
    if(e.code==='KeyR') startGame(true);
  });
  window.addEventListener('keyup',(e)=>keys.delete(e.code));
  startBtn.addEventListener('click',()=>startGame());
  musicBtn.addEventListener('click',()=>{
    musicOn=!musicOn;
    musicBtn.textContent='Muzyka: '+(musicOn?'ON':'OFF');
    if(!musicOn){ musicHappy.pause(); musicDark.pause(); }
    else { if(boka.cloudActive) {musicDark.play(); musicHappy.pause();} else {musicHappy.play(); musicDark.pause();} }
  });

  // Akcje
  function tryUseCloud(){
    if(boka.cloudActive || boka.ammoCloud<=0) return;
    boka.ammoCloud--; ammoCloudText.textContent=boka.ammoCloud;
    boka.cloud=7.0; boka.cloudActive=true; boka.rooted=3.0;
    frostFill.style.width='100%';
    cloudStockFill.style.width = Math.min(100, (boka.ammoCloud/20)*100) + '%';
    if(musicOn){ musicDark.currentTime=0; musicDark.play(); musicHappy.pause(); }
    // zamroź w zasięgu
    mumins.forEach(m=>{ if(m.alive && dist(m.x,m.y,boka.x,boka.y) < CLOUD_MAX_RADIUS){ m.frozen=Math.max(m.frozen,10.0);} });
    if(hunter.alive && dist(hunter.x,hunter.y,boka.x,boka.y) < CLOUD_MAX_RADIUS){
      if(hunter.frozen<=0) hunter.freezeHits++;
      hunter.frozen=Math.max(hunter.frozen,60.0);
      if(hunter.freezeHits>=10){ hunter.alive=false; } // znika, ale gra trwa dalej
    }
  }
  function fireIceBolt(){
    if(boka.ammoAlt<=0) return;
    const dirLen=Math.hypot(boka.lookX,boka.lookY)||1;
    const ux=boka.lookX/dirLen, uy=boka.lookY/dirLen;
    boka.ammoAlt--; ammoAltText.textContent=boka.ammoAlt;
    ammoAltFill.style.width = Math.min(100,(boka.ammoAlt/100)*100)+'%';
    iceBolts.push({x:boka.x+ux*16, y:boka.y+uy*16, vx:ux*7.3, vy:uy*7.3, ttl:2.5});
  }

  // Główna pętla
  function update(now){
    if(!playing) return;
    const d=diff(level);
    const dt=Math.min(0.033,(now-lastTick)/16.666);
    lastTick=now;
    if(paused){ draw(); requestAnimationFrame(update); return; }

    // Pogoda – drobne efekty wewnątrz draw()

    // Timery chmury i zakorzenienia
    if(boka.cloudActive){
      boka.cloud -= dt; if(boka.cloud<=0){ boka.cloud=0; boka.cloudActive=false; if(musicOn){ musicDark.pause(); musicHappy.play(); } }
      frostFill.style.width = (boka.cloud/7.0*100)+'%';
    } else frostFill.style.width='0%';
    if(boka.rooted>0) boka.rooted-=dt;

    // Buka ruch + muchomor
    if(boka.growT>0) boka.growT-=dt;
    const sizeMul = (boka.growT>0)? 4.0 : 1.0;
    boka.r = BOKA_R_BASE * sizeMul;
    const spMul = (boka.growT>0)? 1.33 : 1.0;
    if(!boka.cloudActive && boka.rooted<=0){
      let ax=0,ay=0;
      if(keys.has('ArrowUp')||keys.has('KeyW')) ay-=1;
      if(keys.has('ArrowDown')||keys.has('KeyS')) ay+=1;
      if(keys.has('ArrowLeft')||keys.has('KeyA')) ax-=1;
      if(keys.has('ArrowRight')||keys.has('KeyD')) ax+=1;
      if(ax||ay){ const l=Math.hypot(ax,ay); ax/=l; ay/=l; boka.lookX=ax; boka.lookY=ay; }
      const sp=BOKA_BASE_SPEED*CELL/10*spMul;
      const moved=moveCircle(boka, ax*sp*dt, ay*sp*dt, boka.r);
      boka.x=moved.x; boka.y=moved.y;
    }

    // Trucizna z ogników
    if(boka.poison>0){ boka.hp -= d.projDps*dt; boka.poison=Math.max(0,boka.poison-dt); }
    hpFill.style.width = Math.max(0, Math.min(100, (boka.hp/HP_MAX)*100))+'%';

    // Hunter
    if(hunter.alive){
      if(hunter.frozen>0) hunter.frozen-=dt;
      else{
        const dx=boka.x-hunter.x, dy=boka.y-hunter.y, distH=Math.hypot(dx,dy);
        if(distH>1){
          const ux=dx/distH, uy=dy/distH;
          const moved=moveCircle(hunter, ux*d.hunterSpeed, uy*d.hunterSpeed, HUNTER_R);
          hunter.x=moved.x; hunter.y=moved.y;
        }
        hunter.tShot-=dt;
        if(hunter.tShot<=0 && distH<HUNTER_AIM_RANGE && !(boka.cloudActive&&boka.rooted>0)){
          const speed=d.hunterProjSpeed;
          projs.push({x:hunter.x,y:hunter.y, vx:(dx/distH)*speed, vy:(dy/distH)*speed, ttl:6});
          hunter.tShot=d.fireCooldown*(0.9+Math.random()*0.4);
        }
      }
      freezeT.textContent = (hunter.frozen>0? Math.ceil(hunter.frozen)+'s':'0s');
    } else {
      freezeT.textContent = '—';
    }

    // Ogniki
    for(let i=projs.length-1;i>=0;i--){
      const p=projs[i];
      p.ttl-=dt; if(p.ttl<=0){projs.splice(i,1); continue;}
      const moved=moveCircle(p, p.vx, p.vy, 2); p.x=moved.x; p.y=moved.y;
      if(dist(p.x,p.y,boka.x,boka.y)<boka.r+4){ boka.poison=2.5; projs.splice(i,1); }
    }

    // Pioruny mrozu
    for(let i=iceBolts.length-1;i>=0;i--){
      const b=iceBolts[i];
      b.ttl-=dt; if(b.ttl<=0){iceBolts.splice(i,1); continue;}
      const moved=moveCircle(b, b.vx, b.vy, 2); b.x=moved.x; b.y=moved.y;
      // mrożenie muminka
      for(const m of mumins){
        if(!m.alive) continue;
        if(dist(b.x,b.y,m.x,m.y)<m.r+4){ m.frozen=Math.max(m.frozen,10.0); b.ttl=0; break; }
      }
      // mrożenie Włóczykija
      if(hunter.alive && dist(b.x,b.y,hunter.x,hunter.y)<HUNTER_R+4){
        if(hunter.frozen<=0) hunter.freezeHits++;
        hunter.frozen=Math.max(hunter.frozen,60.0);
        if(hunter.freezeHits>=10){ hunter.alive=false; }
        b.ttl=0;
      }
    }

    // Muminki
    let aliveCount=0;
    mumins.forEach(m=>{
      if(!m.alive) return;
      aliveCount++;
      if(m.frozen>0){ m.frozen-=dt; }
      else{
        const dx=boka.x-m.x, dy=boka.y-m.y, dd=Math.hypot(dx,dy);
        let see=false;
        if(dd<260){
          const steps=Math.ceil(dd/8); let ok=true;
          for(let k=1;k<steps;k++){ const xx=m.x+dx*(k/steps), yy=m.y+dy*(k/steps); const c=Math.floor(xx/CELL), r=Math.floor(yy/CELL); if(isWall(c,r)){ok=false;break;} }
          see=ok;
        }
        if(see){
          m.hide=true;
          let target=null, best=1e9;
          for(let r=0;r<ROWS;r++) for(let c=0;c<COLS;c++) if(grid[r][c]===2){
            const tx=c*CELL+CELL/2, ty=r*CELL+CELL/2; const d2=dist(m.x,m.y,tx,ty);
            if(d2<best){best=d2; target={x:tx,y:ty}}
          }
          if(target){ const ux=(target.x-m.x)/best, uy=(target.y-m.y)/best; const moved=moveCircle(m, ux*2.4, uy*2.4, m.r); m.x=moved.x; m.y=moved.y; }
          if(Math.random()<0.35*dt*3){ fearClouds.push({x:m.x,y:m.y,r:8, ttl:10}); }
        } else {
          m.hide=false;
          if(Math.random()<0.02) m.dir=Math.random()*Math.PI*2;
          const moved=moveCircle(m, Math.cos(m.dir)*1.0, Math.sin(m.dir)*1.0, m.r); m.x=moved.x; m.y=moved.y;
        }
      }
      // zjedzenie
      if(dist(m.x,m.y,boka.x,boka.y) < boka.r+m.r && !inHouse(m.x,m.y)){
        m.alive=false; aliveCount--; score+=50; scoreEl.textContent=score;
        blueClouds.push({x:m.x,y:m.y,r:10, ttl:15});
        // dodatkowo +3 zapasu chmury
        boka.ammoCloud+=3; ammoCloudText.textContent=boka.ammoCloud;
        cloudStockFill.style.width = Math.min(100,(boka.ammoCloud/20)*100)+'%';
      }
    });

    // Postęp
    const totalM = mumins.length||1;
    progressEl.textContent = Math.round(((totalM-aliveCount)/totalM)*100)+'%';
    leftEl.textContent = aliveCount;

    // Pickupy – pioruny/chmurki z respawnem
    for(let i=0;i<boltPickups.length;i++){
      const p=boltPickups[i];
      if(p.alive && dist(p.x,p.y,boka.x,boka.y) < boka.r+p.r){
        boka.ammoAlt = Math.min(999, boka.ammoAlt+10);
        ammoAltText.textContent=boka.ammoAlt;
        ammoAltFill.style.width = Math.min(100,(boka.ammoAlt/100)*100)+'%';
        boltPickups.onCollected(i);
      }
      if(!p.alive && boltTimers[i]>0){ boltTimers[i]-=dt; if(boltTimers[i]<=0){ // respawn nowy
          // przenieś
          for(let t=0;t<100;t++){
            const c=1+rr(0,COLS-2), r=1+rr(0,ROWS-2);
            if(grid[r][c]!==0) continue;
            p.x=c*CELL+CELL/2; p.y=r*CELL+CELL/2; break;
          }
          p.alive=true;
        }
      }
    }
    for(let i=0;i<cloudPickups.length;i++){
      const p=cloudPickups[i];
      if(p.alive && dist(p.x,p.y,boka.x,boka.y) < boka.r+p.r){
        boka.ammoCloud += 5;
        ammoCloudText.textContent=boka.ammoCloud;
        cloudStockFill.style.width = Math.min(100,(boka.ammoCloud/20)*100)+'%';
        cloudPickups.onCollected(i);
      }
      if(!p.alive && cloudTimers[i]>0){ cloudTimers[i]-=dt; if(cloudTimers[i]<=0){
          for(let t=0;t<100;t++){
            const c=1+rr(0,COLS-2), r=1+rr(0,ROWS-2);
            if(grid[r][c]!==0) continue;
            p.x=c*CELL+CELL/2; p.y=r*CELL+CELL/2; break;
          }
          p.alive=true;
        }
      }
    }

    // Muchomory
    for(const m of mushrooms){
      if(m.alive!==false && dist(m.x,m.y,boka.x,boka.y)<boka.r+m.r){
        m.alive=false; boka.growT=15;
      }
    }

    // Chmurki nagród
    for(let i=fearClouds.length-1;i>=0;i--){
      const f=fearClouds[i]; f.ttl-=dt; if(f.ttl<=0){fearClouds.splice(i,1); continue;}
      if(dist(f.x,f.y,boka.x,boka.y)<boka.r+f.r){ boka.hp=Math.min(HP_MAX, boka.hp+5); score+=10; scoreEl.textContent=score; fearClouds.splice(i,1); }
    }
    for(let i=blueClouds.length-1;i>=0;i--){
      const b=blueClouds[i]; b.ttl-=dt; if(b.ttl<=0){blueClouds.splice(i,1); continue;}
      if(dist(b.x,b.y,boka.x,boka.y)<boka.r+b.r){
        boka.hp=Math.min(HP_MAX, boka.hp+20);
        boka.ammoCloud++; ammoCloudText.textContent=boka.ammoCloud;
        cloudStockFill.style.width = Math.min(100,(boka.ammoCloud/20)*100)+'%';
        blueClouds.splice(i,1);
      }
    }

    // Warunki końca poziomu
    if(aliveCount===0){
      level = Math.min(10, level+1);
      overlay.hidden=false;
      document.getElementById('title').textContent = (level>10?'Gratulacje!':'Poziom ukończony');
      document.getElementById('desc').textContent = (level>10?'Przeszedłeś wszystkie 10 poziomów! Możesz grać dalej, restartuj R.':'Przejdź do następnego poziomu.');
      playing=false;
      return;
    }

    if(boka.hp<=0){
      playing=false; overlay.hidden=false;
      document.getElementById('title').textContent='Przegrana';
      document.getElementById('desc').textContent='Ogniki cię wyczerpały. Spróbuj ponownie.';
      return;
    }

    draw();
    requestAnimationFrame(update);
  }

  // Rysowanie
  function draw(){
    const th=themeFor(level);
    // tło
    ctx.clearRect(0,0,canvas.width,canvas.height);
    for(let r=0;r<ROWS;r++) for(let c=0;c<COLS;c++){
      const [x,y,w,h]=cellRect(c,r);
      const t=grid[r][c];
      let col = (t===1? th.wall : (t===2? shade(th.path,0.8) : th.path));
      if(boka.cloudActive){ col = shade(col,0.8); }
      ctx.fillStyle=col; ctx.fillRect(x,y,w,h);
      if(t===2){ ctx.strokeStyle='rgba(200,255,220,0.25)'; ctx.strokeRect(x+3,y+3,w-6,h-6); }
    }

    // elementy środowiska
    for(const t of trees){
      ctx.fillStyle=shade(th.accent,0.4); ctx.fillRect(t.x-6, t.y+5, 12, 6);
      ctx.fillStyle=th.accent; ctx.beginPath(); ctx.moveTo(t.x, t.y-18); ctx.lineTo(t.x-12, t.y+8); ctx.lineTo(t.x+12, t.y+8); ctx.closePath(); ctx.fill();
      ctx.fillStyle=shade(th.accent,0.5); ctx.fillRect(t.x-2, t.y+8, 4, 8);
    }
    for(const m of mushrooms){
      if(m.alive===false) continue;
      ctx.fillStyle='#eddcc8'; ctx.fillRect(m.x-2, m.y-4, 4, 6);
      ctx.fillStyle='#d3222a'; ctx.beginPath(); ctx.ellipse(m.x, m.y-4, 8, 5, 0, 0, Math.PI, true); ctx.fill();
      ctx.fillStyle='#fff'; ctx.beginPath(); ctx.arc(m.x-3,m.y-6,1.2,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(m.x+2,m.y-5,1.4,0,Math.PI*2); ctx.fill();
    }

    // Pickupy – pioruny
    boltPickups.forEach(p=>{
      if(!p.alive) return;
      const g=ctx.createRadialGradient(p.x,p.y,2,p.x,p.y,12);
      g.addColorStop(0,'#dff4ff'); g.addColorStop(1,'#5ab0ff');
      ctx.strokeStyle='#aee1ff'; ctx.fillStyle=g;
      ctx.beginPath();
      // błyskawica
      ctx.moveTo(p.x, p.y-10); ctx.lineTo(p.x+5, p.y-2); ctx.lineTo(p.x+1, p.y-2); ctx.lineTo(p.x+8, p.y+10); ctx.lineTo(p.x-4, p.y+0); ctx.lineTo(p.x+2, p.y+0); ctx.closePath();
      ctx.fill(); ctx.stroke();
    });
    // Pickupy – chmurki
    cloudPickups.forEach(p=>{
      if(!p.alive) return;
      ctx.fillStyle='rgba(180,220,255,0.95)';
      const x=p.x, y=p.y;
      ctx.beginPath();
      ctx.arc(x-6,y,6,0,Math.PI*2);
      ctx.arc(x,y-4,7,0,Math.PI*2);
      ctx.arc(x+7,y,5,0,Math.PI*2);
      ctx.closePath(); ctx.fill();
      ctx.strokeStyle='rgba(120,170,210,0.8)'; ctx.stroke();
    });

    // chmurki strachu / nagrody
    fearClouds.forEach(f=>{ ctx.fillStyle='rgba(255,230,120,0.55)'; ctx.beginPath(); ctx.arc(f.x,f.y,f.r,0,Math.PI*2); ctx.fill(); });
    blueClouds.forEach(b=>{ ctx.fillStyle='rgba(140,200,255,0.7)'; ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill(); });

    // Muminki
    mumins.forEach(m=>{
      if(!m.alive) return;
      ctx.save(); ctx.translate(m.x,m.y);
      const body = (m.frozen>0)? 'rgba(220,240,255,0.95)' : (m.hide ? 'rgba(255,255,255,0.8)' : '#f7f7f7');
      ctx.fillStyle=body;
      ctx.beginPath(); ctx.ellipse(0,4,8,11,0,0,Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.ellipse(0,-10,6,5,0,0,Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.ellipse(-3,-15,2,3,0,0,Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.ellipse(3,-15,2,3,0,0,Math.PI*2); ctx.fill();
      ctx.restore();
    });

    // Ogniki
    projs.forEach(p=>{ ctx.fillStyle='#a9ffbf'; ctx.beginPath(); ctx.arc(p.x,p.y,3,0,Math.PI*2); ctx.fill(); });

    // Pioruny mrozu
    iceBolts.forEach(b=>{
      ctx.strokeStyle='rgba(160,220,255,0.9)';
      ctx.beginPath(); ctx.moveTo(b.x-3,b.y); ctx.lineTo(b.x+3,b.y); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(b.x,b.y-3); ctx.lineTo(b.x,b.y+3); ctx.stroke();
    });

    // Włóczykij – smuklejsza sylweta
    if(hunter.alive){
      ctx.save(); ctx.translate(hunter.x,hunter.y);
      const frozen=hunter.frozen>0;
      ctx.fillStyle=frozen ? 'rgba(160,240,220,0.9)' : '#7de6a9';
      // wysoki stożkowy kapelusz
      ctx.beginPath(); ctx.moveTo(-8,-10); ctx.lineTo(8,-10); ctx.lineTo(0,-26); ctx.closePath(); ctx.fill();
      // smukły płaszcz
      ctx.beginPath(); ctx.moveTo(0,-10); ctx.lineTo(-9,14); ctx.lineTo(9,14); ctx.closePath(); ctx.fill();
      if(frozen){ ctx.strokeStyle='rgba(180,255,255,0.8)'; ctx.strokeRect(-11,-28,22,44); }
      ctx.restore();
    }

    // Buka
    const glow=10+6*Math.sin(performance.now()/180);
    ctx.save(); ctx.translate(boka.x,boka.y);
    ctx.shadowColor='#7ad1ff'; ctx.shadowBlur=glow;
    ctx.fillStyle=boka.cloudActive?'#5aa7d4':'#7ad1ff';
    ctx.beginPath(); ctx.ellipse(0,2,boka.r*0.93,boka.r*1.3,0,0,Math.PI*2); ctx.fill();
    ctx.fillStyle=boka.cloudActive?'rgba(120,160,190,0.5)':'rgba(170,220,255,0.5)';
    ctx.beginPath(); ctx.ellipse(0,8,boka.r*1.1,6,0,0,Math.PI*2); ctx.fill();
    ctx.shadowBlur=0;
    // oczy
    const el=Math.hypot(boka.lookX,boka.lookY)||1; const ex=(boka.lookX/el)*2.2, ey=(boka.lookY/el)*2.2;
    ctx.fillStyle='#eef9ff';
    ctx.beginPath(); ctx.ellipse(-4,-4,3,4,0,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.ellipse(4,-4,3,4,0,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#0b1c10'; ctx.beginPath(); ctx.arc(-4+ex,-4+ey,1.6,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(4+ex,-4+ey,1.6,0,Math.PI*2); ctx.fill();
    ctx.restore();

    // Chmura mrozu
    if(boka.cloudActive){
      const radius=CLOUD_MAX_RADIUS*(boka.cloud/7.0);
      const grd=ctx.createRadialGradient(boka.x,boka.y,10,boka.x,boka.y,radius);
      grd.addColorStop(0,'rgba(0,0,0,0.8)');
      grd.addColorStop(0.6,'rgba(0,0,0,0.6)');
      grd.addColorStop(1,'rgba(0,0,0,0)');
      ctx.fillStyle=grd; ctx.beginPath(); ctx.arc(boka.x,boka.y,radius,0,Math.PI*2); ctx.fill();
      ctx.strokeStyle='rgba(140,200,255,0.35)'; ctx.beginPath(); ctx.arc(boka.x,boka.y,Math.max(0,radius-6),0,Math.PI*2); ctx.stroke();
    }

    // Efekty pogody
    if(weather==='Noc'){
      ctx.fillStyle='rgba(0,0,30,0.25)'; ctx.fillRect(0,0,canvas.width,canvas.height);
    } else if(weather==='Deszcz'){
      ctx.strokeStyle='rgba(180,200,255,0.25)';
      for(let i=0;i<50;i++){
        const x=(performance.now()/10 + i*50)%canvas.width;
        const y=(i*37 + performance.now()/3)%canvas.height;
        ctx.beginPath(); ctx.moveTo(x,y); ctx.lineTo(x+4,y+10); ctx.stroke();
      }
    } else if(weather==='Mgła'){
      ctx.fillStyle='rgba(200,220,220,0.08)'; ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle='rgba(200,220,220,0.08)'; ctx.fillRect(20,20,canvas.width-40,canvas.height-40);
    }

    // Ramka
    ctx.strokeStyle='rgba(255,255,255,0.06)'; ctx.strokeRect(0.5,0.5,canvas.width-1,canvas.height-1);
  }

  function startGame(reset=false){
    overlay.hidden=true;
    if(reset){ level=1; score=0; boka.ammoAlt=100; boka.ammoCloud=5; boka.hp=HP_MAX; }
    ammoAltText.textContent=boka.ammoAlt;
    ammoCloudText.textContent=boka.ammoCloud;
    ammoAltFill.style.width = Math.min(100,(boka.ammoAlt/100)*100)+'%';
    cloudStockFill.style.width = Math.min(100,(boka.ammoCloud/20)*100)+'%';
    resetLevel();
    playing=true; paused=false;
    lastTick=performance.now();
    if(musicOn){ musicHappy.currentTime=0; musicHappy.play(); musicDark.pause(); }
    requestAnimationFrame(update);
  }

  // util koloru
  function shade(hex, f){
    // proste przyciemnienie
    const c = hex.replace('#','');
    const r=parseInt(c.substr(0,2),16), g=parseInt(c.substr(2,2),16), b=parseInt(c.substr(4,2),16);
    const nr=Math.round(r*f), ng=Math.round(g*f), nb=Math.round(b*f);
    return `rgb(${nr},${ng},${nb})`;
  }

  overlay.hidden=false;
})();
</script>
</body>
</html>
