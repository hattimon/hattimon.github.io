<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>BUKA w Dolinie Muminków</title>
<style>
  :root{
    --cell: 32px; --cols: 25; --rows: 18;
    --bg:#0b1c10; --path:#0f2a18; --wall:#23402a;
    --tree:#2d5b33; --cap:#d3222a; --stem:#eddcc8;
    --buka:#7ad1ff; --hunter:#6ef0a7; --text:#e6ffe6;
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial,sans-serif}
  .wrap{min-height:100%;display:grid;place-items:center;gap:10px;padding:10px}
  h1{margin:6px 0 2px;font-size:20px}
  /* HUD – wiersz pod wierszem */
  .hud{display:grid;grid-template-columns:1fr;gap:6px;align-items:center;min-width:820px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .badge{background:#173a24;border:1px solid #2a5b3c;padding:6px 10px;border-radius:8px}
  .meter{position:relative;flex:1;min-width:260px;height:16px;background:#113621;border:1px solid #2a5b3c;border-radius:6px;overflow:hidden}
  .meter>.fill{position:absolute;inset:0;width:0%}
  .hp .fill{background:linear-gradient(90deg,#36d17c,#8fffd0)}
  .frost .fill{background:linear-gradient(90deg,#000,#333)}
  .cloudAmmo .fill{background:linear-gradient(90deg,#203848,#3b5c70)}
  .ammoAlt .fill{background:linear-gradient(90deg,#85c6ff,#4190ff)}
  .grid{position:relative;width:calc(var(--cell)*var(--cols));height:calc(var(--cell)*var(--rows));background:var(--path);border-radius:10px;overflow:hidden;box-shadow:0 0 0 3px #163c25 inset,0 10px 30px rgba(0,0,0,.35)}
  canvas{width:100%;height:100%;image-rendering:pixelated}
  .controls{opacity:.9;font-size:14px}
  .controls kbd{background:#113621;border:1px solid #215035;border-bottom-width:3px;padding:2px 6px;border-radius:5px;font-family:ui-monospace,Menlo,monospace}
  .overlay{position:absolute;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.55);color:white;text-align:center;padding:24px;backdrop-filter:blur(2px)}
  .overlay[hidden]{display:none !important;pointer-events:none}
  .overlay .card{background:rgba(16,40,28,.9);border:1px solid #2a5b3c;border-radius:12px;padding:18px 20px;max-width:560px}
  button{background:#2a5b3c;color:white;border:0;padding:10px 14px;border-radius:8px;font-weight:700;cursor:pointer}
  button:hover{filter:brightness(1.1)}
  .mute{background:#20543a}
</style>
</head>
<body>
<div class="wrap">
  <h1>BUKA w Dolinie Muminków</h1>

  <!-- HUD: wiersze -->
  <div class="hud">
    <div class="row">
      <div class="badge">Cele do zebrania: Muminki <span id="left">0</span> • Kryształy 5 • Muchomory <span id="mushLeft">?</span></div>
    </div>
    <div class="row">
      <div class="badge">Punkty: <span id="score">0</span></div>
    </div>
    <div class="row">
      <div class="badge">Poziom: <span id="level">1</span></div>
      <div class="badge">Mróz Włóczykija: <span id="freezeT">0s</span></div>
    </div>
    <div class="row">
      <div class="badge">Amunicja Alt (Pioruny): <span id="ammoAltText">100</span></div>
      <div class="badge">Amunicja Spacja (Chmura): <span id="ammoCloudText">5</span></div>
    </div>
    <div class="row">
      <div class="meter frost" title="Czas aktywnej chmury"><div id="frostFill" class="fill" style="width:0%"></div></div>
    </div>
    <div class="row">
      <div class="meter cloudAmmo" title="Zapasy amunicji chmury"><div id="cloudStockFill" class="fill" style="width:0%"></div></div>
    </div>
    <div class="row">
      <div class="meter hp" title="Życie"><div id="hpFill" class="fill" style="width:100%"></div></div>
      <button id="musicBtn" class="mute">Muzyka: ON</button>
    </div>
    <div class="row controls">
      Sterowanie: <kbd>WASD</kbd>/<kbd>Strzałki</kbd> – ruch, <kbd>Spacja</kbd> – chmura, <kbd>Alt</kbd> – piorun, <kbd>P</kbd> – pauza, <kbd>R</kbd> – restart
    </div>
  </div>

  <div class="grid">
    <canvas id="game" width="800" height="576"></canvas>
    <div id="overlay" class="overlay">
      <div class="card">
        <div id="title" style="font-size:22px;margin-bottom:6px;">Buka budzi mróz…</div>
        <div id="desc" style="opacity:.9;margin-bottom:10px;">
          Zbieraj kryształy (uzupełniają chmurę – Spacja). Alt strzela piorunem (osobna amunicja). Muchomory pod drzewami dają 4× rozmiar i +33% szybkości na 15 s.
        </div>
        <button id="startBtn">Start</button>
      </div>
    </div>
  </div>
</div>

<!-- Muzyka przykładowa (możesz podmienić src na swoje) -->
<audio id="musicHappy" loop preload="auto" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_d0b2a58b8a.mp3?filename=happy-day-112194.mp3"></audio>
<audio id="musicDark" loop preload="auto" src="https://cdn.pixabay.com/download/audio/2021/12/20/audio_8e2b2e6fa2.mp3?filename=dark-ambient-110011.mp3"></audio>

<script>
(() => {
  // Stałe
  const CELL=32, COLS=25, ROWS=18;
  const WALL_DENSITY=0.32; // trochę gęściej
  const RNG_SEED=7777;

  const BOKA_BASE_SPEED=3.1, BOKA_R_BASE=14;
  const HUNTER_SPEED=2.7, HUNTER_R=12;
  // słabsze ogniki i znacznie rzadsze strzały
  const HUNTER_PROJ_SPEED=4.2;
  const HUNTER_FIRE_COOLDOWN=1.8*5; // 5× rzadziej
  const HUNTER_AIM_RANGE=360;
  const PROJ_DMG_PER_SEC=14/10; // 10× słabsze

  const MUMIN_R=11, MUMINS_BASE=8;
  const MUMIN_FEAR_DROP_RATE=0.35;
  const CLOUD_DURATION=7.0, CLOUD_FREEZE_MUMIN=10.0, BOKA_ROOT_TIME=3.0;
  const HUNTER_FREEZE_TIME=60.0, FREEZE_TICKS_TO_KILL=10;
  const HP_MAX=100;

  const MIN_BOARD=Math.min(COLS*CELL, ROWS*CELL);
  const CLOUD_MAX_RADIUS=Math.floor(MIN_BOARD/5);

  // DOM
  const canvas=document.getElementById('game');
  const ctx=canvas.getContext('2d');
  const overlay=document.getElementById('overlay');
  const startBtn=document.getElementById('startBtn');
  const leftEl=document.getElementById('left');
  const mushLeftEl=document.getElementById('mushLeft');
  const lvlEl=document.getElementById('level');
  const scoreEl=document.getElementById('score');
  const hpFill=document.getElementById('hpFill');
  const frostFill=document.getElementById('frostFill');
  const cloudStockFill=document.getElementById('cloudStockFill');
  const ammoAltText=document.getElementById('ammoAltText');
  const ammoCloudText=document.getElementById('ammoCloudText');
  const freezeT=document.getElementById('freezeT');
  const musicBtn=document.getElementById('musicBtn');
  const musicHappy=document.getElementById('musicHappy');
  const musicDark=document.getElementById('musicDark');

  // RNG
  function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return((t^t>>>14)>>>0)/4294967296}}
  let rng=mulberry32(RNG_SEED);
  function rr(a,b){return Math.floor(a+(b-a)*Math.random());}

  // Mapa i ozdoby
  let grid=[];
  const trees=[];      // drzewka
  const mushrooms=[];  // muchomory
  function isWall(c,r){if(r<0||c<0||r>=ROWS||c>=COLS)return true;return grid[r][c]===1}
  function genMap(level){
    rng=mulberry32(RNG_SEED+level*97);
    grid=Array.from({length:ROWS},()=>Array(COLS).fill(0));
    for(let r=0;r<ROWS;r++)for(let c=0;c<COLS;c++) if(r===0||c===0||r===ROWS-1||c===COLS-1) grid[r][c]=1;
    for(let r=1;r<ROWS-1;r++) for(let c=1;c<COLS-1;c++) if(Math.random()<WALL_DENSITY) grid[r][c]=1;
    let snakes=9;
    while(snakes--){
      let r=(ROWS>>1)+rr(-3,3), c=(COLS>>1)+rr(-3,3);
      for(let i=0;i<230;i++){
        grid[r][c]=0;
        const d=rr(0,4);
        if(d===0&&r>1)r--; if(d===1&&r<ROWS-2)r++;
        if(d===2&&c>1)c--; if(d===3&&c<COLS-2)c++;
      }
    }
    // Domek 3x3
    let dr=0,dc=0;
    for(let tries=0;tries<200;tries++){
      const r=2+rr(0,ROWS-5), c=2+rr(0,COLS-5);
      let ok=true; for(let rr2=r;rr2<r+3;rr2++) for(let cc=c;cc<c+3;cc++) if(isWall(cc,rr2)) ok=false;
      if(ok){dr=r;dc=c;break;}
    }
    for(let rr2=dr;rr2<dr+3;rr2++) for(let cc=dc;cc<dc+3;cc++) grid[rr2][cc]=2;

    // Drzewka + muchomory przy nich
    trees.length=0; mushrooms.length=0;
    const treeCount=18;
    let placed=0;
    while(placed<treeCount){
      const c=1+rr(0,COLS-2), r=1+rr(0,ROWS-2);
      if(grid[r][c]!==0) continue;
      const x=c*CELL+CELL/2, y=r*CELL+CELL/2;
      trees.push({x,y});
      // muchomor pod drzewem (30% szans)
      if(Math.random()<0.3) mushrooms.push({x:x+rr(-8,9), y:y+rr(6,12), r:6, alive:true});
      placed++;
    }
  }
  function inHouse(x,y){const c=Math.floor(x/CELL), r=Math.floor(y/CELL); return grid[r] && grid[r][c]===2;}

  // Obiekty
  const boka={x:CELL*1.5,y:CELL*1.5,r:BOKA_R_BASE,hp:HP_MAX,poison:0,
              ammoAlt:100, ammoCloud:5,
              cloud:0, cloudActive:false, rooted:0, lookX:1, lookY:0,
              growT:0}; // muchomor efekt
  const hunter={x:CELL*(COLS-2.5), y:CELL*(ROWS-2.5), r:HUNTER_R, frozen:0, freezeHits:0, tShot:0};
  const mumins=[], fearClouds=[], blueClouds=[], crystals=[], projs=[], iceBolts=[];
  let level=1, score=0;
  let playing=false, paused=false, musicOn=true;
  let lastTick=0;

  // Helpers
  function cellRect(c,r){return [c*CELL,r*CELL,CELL,CELL]}
  function dist(a,b,x,y){const dx=a-x,dy=b-y;return Math.hypot(dx,dy)}
  function moveCircle(obj,vx,vy,rad){
    let nx=obj.x+vx, ny=obj.y+vy;
    const minX=rad, minY=rad, maxX=COLS*CELL-rad, maxY=ROWS*CELL-rad;
    nx=Math.max(minX,Math.min(maxX,nx)); ny=Math.max(minY,Math.min(maxY,ny));
    const c=Math.floor(nx/CELL), r=Math.floor(ny/CELL);
    for(let rr2=r-1;rr2<=r+1;rr2++) for(let cc=c-1;cc<=c+1;cc++){
      if(!isWall(cc,rr2)) continue;
      const rx=cc*CELL, ry=rr2*CELL;
      const cx=Math.max(rx,Math.min(nx,rx+CELL));
      const cy=Math.max(ry,Math.min(ny,ry+CELL));
      const dx=nx-cx, dy=ny-cy, d2=dx*dx+dy*dy;
      if(d2<rad*rad-1){
        const d=Math.sqrt(Math.max(d2,1e-4));
        const ux=dx/d, uy=dy/d;
        nx=cx+ux*(rad+0.5); ny=cy+uy*(rad+0.5);
      }
    }
    return {x:nx,y:ny};
  }

  function resetLevel(){
    genMap(level);
    mumins.length=0; fearClouds.length=0; blueClouds.length=0; crystals.length=0; projs.length=0; iceBolts.length=0;
    boka.x=CELL*1.5; boka.y=CELL*1.5; boka.hp=HP_MAX; boka.poison=0; boka.cloud=0; boka.cloudActive=false; boka.rooted=0; boka.lookX=1; boka.lookY=0; boka.growT=0;
    hunter.x=CELL*(COLS-2.5); hunter.y=CELL*(ROWS-2.5); hunter.frozen=0; hunter.tShot=0;

    // Muminki
    const toPlace=MUMINS_BASE+Math.floor(level*1.4);
    let i=0;
    while(i<toPlace){
      const c=1+rr(0,COLS-2), r=1+rr(0,ROWS-2);
      if(isWall(c,r)||grid[r][c]===2) continue;
      const x=c*CELL+CELL/2, y=r*CELL+CELL/2;
      if(dist(x,y,boka.x,boka.y)<60) continue;
      mumins.push({x,y,r:MUMIN_R, alive:true, hide:false, frozen:0, dir:Math.random()*Math.PI*2});
      i++;
    }
    // 5 kryształów (chmura)
    let k=0;
    while(k<5){
      const c=1+rr(0,COLS-2), r=1+rr(0,ROWS-2);
      if(isWall(c,r)||grid[r][c]===2) continue;
      const x=c*CELL+CELL/2, y=r*CELL+CELL/2;
      if(crystals.some(q=>dist(q.x,q.y,x,y)<20)) continue;
      crystals.push({x,y,r:9});
      k++;
    }

    leftEl.textContent = mumins.filter(m=>m.alive).length;
    mushLeftEl.textContent = mushrooms.filter(m=>m.alive!==false).length;
    lvlEl.textContent = level;
    scoreEl.textContent = score;
    ammoAltText.textContent = boka.ammoAlt;
    ammoCloudText.textContent = boka.ammoCloud;
    cloudStockFill.style.width = Math.min(100, (boka.ammoCloud/10)*100) + '%';
  }

  // Wejście
  const keys=new Set();
  window.addEventListener('keydown', (e)=>{
    const mv=['ArrowUp','ArrowDown','ArrowLeft','ArrowRight','KeyW','KeyA','KeyS','KeyD'];
    if(mv.includes(e.code)){ e.preventDefault(); keys.add(e.code); }
    if(e.code==='Space'){ e.preventDefault(); tryUseCloud(); }
    if(e.code==='AltLeft' || e.code==='AltRight'){ e.preventDefault(); fireIceBolt(); }
    if(e.code==='KeyP') paused=!paused;
    if(e.code==='KeyR') startGame(true);
  });
  window.addEventListener('keyup',(e)=>keys.delete(e.code));
  startBtn.addEventListener('click',()=>startGame());
  musicBtn.addEventListener('click',()=>{
    musicOn=!musicOn;
    musicBtn.textContent='Muzyka: '+(musicOn?'ON':'OFF');
    if(!musicOn){ musicHappy.pause(); musicDark.pause(); }
    else { if(boka.cloudActive) {musicDark.play(); musicHappy.pause();} else {musicHappy.play(); musicDark.pause();} }
  });

  // Akcje
  function tryUseCloud(){
    if(boka.cloudActive) return;
    if(boka.ammoCloud<=0) return;
    boka.ammoCloud--; ammoCloudText.textContent=boka.ammoCloud;
    boka.cloud=CLOUD_DURATION; boka.cloudActive=true; boka.rooted=BOKA_ROOT_TIME;
    frostFill.style.width='100%';
    cloudStockFill.style.width = Math.min(100, (boka.ammoCloud/10)*100) + '%';
    if(musicOn){ musicDark.currentTime=0; musicDark.play(); musicHappy.pause(); }
    // zamroź zasięg
    mumins.forEach(m=>{ if(m.alive && dist(m.x,m.y,boka.x,boka.y) < CLOUD_MAX_RADIUS){ m.frozen=Math.max(m.frozen,CLOUD_FREEZE_MUMIN);} });
    if(dist(hunter.x,hunter.y,boka.x,boka.y)<CLOUD_MAX_RADIUS){
      if(hunter.frozen<=0) hunter.freezeHits++;
      hunter.frozen=Math.max(hunter.frozen,HUNTER_FREEZE_TIME);
    }
  }
  function fireIceBolt(){
    if(boka.ammoAlt<=0) return;
    const dirLen=Math.hypot(boka.lookX,boka.lookY)||1;
    const ux=boka.lookX/dirLen, uy=boka.lookY/dirLen;
    boka.ammoAlt--; ammoAltText.textContent=boka.ammoAlt;
    iceBolts.push({x:boka.x+ux*16, y:boka.y+uy*16, vx:ux*7.0, vy:uy*7.0, ttl:2.5});
  }

  function update(now){
    if(!playing) return;
    const dt=Math.min(0.033,(now-lastTick)/16.666);
    lastTick=now;
    if(paused){ draw(); requestAnimationFrame(update); return; }

    // Frost timer UI
    if(boka.cloudActive){
      boka.cloud -= dt;
      if(boka.cloud<=0){ boka.cloud=0; boka.cloudActive=false; if(musicOn){ musicDark.pause(); musicHappy.play(); } }
      frostFill.style.width = (boka.cloud/CLOUD_DURATION*100)+'%';
    } else frostFill.style.width='0%';

    // Buka ruch + efekt muchomora
    if(boka.growT>0) boka.growT-=dt;
    const sizeMul = (boka.growT>0)? 4.0 : 1.0;
    boka.r = BOKA_R_BASE * sizeMul;
    const spMul = (boka.growT>0)? 1.33 : 1.0;

    if(boka.rooted>0) boka.rooted-=dt;
    if(!boka.cloudActive && boka.rooted<=0){
      let ax=0,ay=0;
      if(keys.has('ArrowUp')||keys.has('KeyW')) ay-=1;
      if(keys.has('ArrowDown')||keys.has('KeyS')) ay+=1;
      if(keys.has('ArrowLeft')||keys.has('KeyA')) ax-=1;
      if(keys.has('ArrowRight')||keys.has('KeyD')) ax+=1;
      if(ax||ay){ const l=Math.hypot(ax,ay); ax/=l; ay/=l; boka.lookX=ax; boka.lookY=ay; }
      const sp=BOKA_BASE_SPEED*CELL/10*spMul;
      const moved=moveCircle(boka, ax*sp*dt, ay*sp*dt, boka.r);
      boka.x=moved.x; boka.y=moved.y;
    }

    // Trucizna z ogników
    if(boka.poison>0){ boka.hp -= PROJ_DMG_PER_SEC*dt; boka.poison=Math.max(0,boka.poison-dt); }

    // Hunter
    if(hunter.frozen>0) hunter.frozen-=dt;
    else{
      const dx=boka.x-hunter.x, dy=boka.y-hunter.y, d=Math.hypot(dx,dy);
      if(d>1){ const ux=dx/d, uy=dy/d; const moved=moveCircle(hunter, ux*HUNTER_SPEED, uy*HUNTER_SPEED, HUNTER_R); hunter.x=moved.x; hunter.y=moved.y; }
      hunter.tShot-=dt;
      if(hunter.tShot<=0 && d<HUNTER_AIM_RANGE && !(boka.cloudActive&&boka.rooted>0)){
        const speed=HUNTER_PROJ_SPEED;
        projs.push({x:hunter.x,y:hunter.y, vx:(dx/d)*speed, vy:(dy/d)*speed, ttl:6});
        hunter.tShot=HUNTER_FIRE_COOLDOWN*(0.9+Math.random()*0.4);
      }
    }

    // Ogniki
    for(let i=projs.length-1;i>=0;i--){
      const p=projs[i];
      p.ttl-=dt; if(p.ttl<=0){projs.splice(i,1); continue;}
      const moved=moveCircle(p, p.vx, p.vy, 2); p.x=moved.x; p.y=moved.y;
      if(dist(p.x,p.y,boka.x,boka.y)<boka.r+4){ boka.poison=2.5; projs.splice(i,1); }
    }

    // Pioruny mrozu
    for(let i=iceBolts.length-1;i>=0;i--){
      const b=iceBolts[i];
      b.ttl-=dt; if(b.ttl<=0){iceBolts.splice(i,1); continue;}
      const moved=moveCircle(b, b.vx, b.vy, 2); b.x=moved.x; b.y=moved.y;
      for(const m of mumins){
        if(!m.alive) continue;
        if(dist(b.x,b.y,m.x,m.y)<m.r+4){ m.frozen=Math.max(m.frozen,CLOUD_FREEZE_MUMIN); b.ttl=0; break; }
      }
      if(dist(b.x,b.y,hunter.x,hunter.y)<HUNTER_R+4){
        if(hunter.frozen<=0) hunter.freezeHits++;
        hunter.frozen=Math.max(hunter.frozen,HUNTER_FREEZE_TIME);
        b.ttl=0;
      }
    }

    // Muminki
    mumins.forEach(m=>{
      if(!m.alive) return;
      if(m.frozen>0){ m.frozen-=dt; }
      else{
        const dx=boka.x-m.x, dy=boka.y-m.y, d=Math.hypot(dx,dy);
        let see=false;
        if(d<260){
          const steps=Math.ceil(d/8); let ok=true;
          for(let k=1;k<steps;k++){ const xx=m.x+dx*(k/steps), yy=m.y+dy*(k/steps); const c=Math.floor(xx/CELL), r=Math.floor(yy/CELL); if(isWall(c,r)){ok=false;break;} }
          see=ok;
        }
        if(see){ // uciekaj
          m.hide=true;
          let target=null, best=1e9;
          for(let r=0;r<ROWS;r++) for(let c=0;c<COLS;c++) if(grid[r][c]===2){
            const tx=c*CELL+CELL/2, ty=r*CELL+CELL/2; const dd=dist(m.x,m.y,tx,ty);
            if(dd<best){best=dd; target={x:tx,y:ty}}
          }
          if(target){ const ux=(target.x-m.x)/best, uy=(target.y-m.y)/best; const moved=moveCircle(m, ux*2.3, uy*2.3, MUMIN_R); m.x=moved.x; m.y=moved.y; }
          if(Math.random()<MUMIN_FEAR_DROP_RATE*dt*3){ fearClouds.push({x:m.x,y:m.y,r:8, ttl:10}); }
        } else {
          m.hide=false;
          if(Math.random()<0.02) m.dir=Math.random()*Math.PI*2;
          const moved=moveCircle(m, Math.cos(m.dir)*1.0, Math.sin(m.dir)*1.0, MUMIN_R); m.x=moved.x; m.y=moved.y;
        }
      }
      // zjedzenie przy kontakcie (poza domkiem)
      if(dist(m.x,m.y,boka.x,boka.y) < boka.r+m.r && !inHouse(m.x,m.y)){
        m.alive=false; score+=50; scoreEl.textContent=score;
        // niebieska chmurka + leczenie + 1 zapas chmury
        blueClouds.push({x:m.x,y:m.y,r:10, ttl:15});
        boka.ammoCloud+=3; ammoCloudText.textContent=boka.ammoCloud;
        cloudStockFill.style.width = Math.min(100, (boka.ammoCloud/10)*100) + '%';
      }
    });

    // Kryształy (tylko chmura)
    for(let i=crystals.length-1;i>=0;i--){
      const c=crystals[i];
      if(dist(c.x,c.y,boka.x,boka.y) < boka.r+c.r){
        boka.ammoCloud++; ammoCloudText.textContent=boka.ammoCloud;
        cloudStockFill.style.width = Math.min(100, (boka.ammoCloud/10)*100) + '%';
        crystals.splice(i,1);
      }
    }

    // Muchomory – power-up
    for(const m of mushrooms){
      if(m.alive!==false && dist(m.x,m.y,boka.x,boka.y)<boka.r+m.r){
        m.alive=false; boka.growT=15; // 15 s
      }
    }

    // Chmurki
    for(let i=fearClouds.length-1;i>=0;i--){
      const f=fearClouds[i]; f.ttl-=dt; if(f.ttl<=0){fearClouds.splice(i,1); continue;}
      if(dist(f.x,f.y,boka.x,boka.y)<boka.r+f.r){
        score+=10; scoreEl.textContent=score;
        boka.hp=Math.min(HP_MAX, boka.hp+5);
        fearClouds.splice(i,1);
      }
    }
    for(let i=blueClouds.length-1;i>=0;i--){
      const b=blueClouds[i]; b.ttl-=dt; if(b.ttl<=0){blueClouds.splice(i,1); continue;}
      if(dist(b.x,b.y,boka.x,boka.y)<boka.r+b.r){
        boka.hp=Math.min(HP_MAX, boka.hp+20);
        // bonus 1 zapas chmury
        boka.ammoCloud++; ammoCloudText.textContent=boka.ammoCloud;
        cloudStockFill.style.width = Math.min(100, (boka.ammoCloud/10)*100) + '%';
        blueClouds.splice(i,1);
      }
    }

    // Włóczykij win condition
    if(hunter.freezeHits>=FREEZE_TICKS_TO_KILL){
      score+=500; level++;
      overlay.hidden=false;
      document.getElementById('title').textContent='Włóczykij pokonany';
      document.getElementById('desc').textContent='Zamrożony 10 razy! Start kolejnego poziomu?';
      playing=false; return;
    }

    // UI
    leftEl.textContent = mumins.filter(m=>m.alive).length;
    mushLeftEl.textContent = mushrooms.filter(m=>m.alive!==false).length;
    hpFill.style.width = Math.max(0, Math.min(100, (boka.hp/HP_MAX)*100))+'%';
    freezeT.textContent = (hunter.frozen>0? Math.ceil(hunter.frozen)+'s':'0s');

    if(boka.hp<=0){
      playing=false; overlay.hidden=false;
      document.getElementById('title').textContent='Przegrana';
      document.getElementById('desc').textContent='Ogniki cię wyczerpały. Spróbuj ponownie.';
      return;
    }

    draw();
    requestAnimationFrame(update);
  }

  // Rysowanie
  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    // Tło
    for(let r=0;r<ROWS;r++) for(let c=0;c<COLS;c++){
      const [x,y,w,h]=cellRect(c,r);
      const t=grid[r][c];
      ctx.fillStyle = t===1 ? '#23402a' : (t===2 ? '#163c25' : '#0f2a18');
      if(boka.cloudActive){ ctx.fillStyle = t===1?'#1f3527':(t===2?'#112a1d':'#0b1d12'); }
      ctx.fillRect(x,y,w,h);
      if(t===1){ ctx.fillStyle=boka.cloudActive?'rgba(20,55,38,0.25)':'rgba(25,70,45,0.25)'; ctx.fillRect(x+2,y+2,w-4,h-4); }
      if(t===2){ ctx.strokeStyle=boka.cloudActive?'rgba(90,140,120,0.35)':'rgba(120,200,160,0.4)'; ctx.strokeRect(x+3,y+3,w-6,h-6); }
    }

    // Drzewka
    for(const t of trees){
      ctx.fillStyle='#1b3b22';
      ctx.fillRect(t.x-6, t.y+5, 12, 6); // cień
      ctx.fillStyle=varColor('--tree','#2d5b33');
      ctx.beginPath(); ctx.moveTo(t.x, t.y-18); ctx.lineTo(t.x-12, t.y+8); ctx.lineTo(t.x+12, t.y+8); ctx.closePath(); ctx.fill();
      ctx.fillStyle='#4a2e1c'; ctx.fillRect(t.x-2, t.y+8, 4, 8); // pień
    }
    // Muchomory
    for(const m of mushrooms){
      if(m.alive===false) continue;
      // trzonek
      ctx.fillStyle='rgba(237,220,200,0.95)'; ctx.fillRect(m.x-2, m.y-4, 4, 6);
      // kapelusz
      ctx.fillStyle='#d3222a'; ctx.beginPath(); ctx.ellipse(m.x, m.y-4, 8, 5, 0, 0, Math.PI, true); ctx.fill();
      // kropki
      ctx.fillStyle='#fff'; ctx.beginPath(); ctx.arc(m.x-3,m.y-6,1.2,0,Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.arc(m.x+2,m.y-5,1.4,0,Math.PI*2); ctx.fill();
    }

    // Kryształy
    crystals.forEach(c=>{
      const g=ctx.createRadialGradient(c.x,c.y,2,c.x,c.y,10);
      g.addColorStop(0,'#9ff'); g.addColorStop(1,'#39a');
      ctx.fillStyle=g; ctx.beginPath(); ctx.moveTo(c.x,c.y-9); ctx.lineTo(c.x+7,c.y+5); ctx.lineTo(c.x-7,c.y+5); ctx.closePath(); ctx.fill();
      ctx.strokeStyle='rgba(200,240,255,0.8)'; ctx.stroke();
    });

    // Chmurki
    fearClouds.forEach(f=>{ ctx.fillStyle='rgba(255,230,120,0.55)'; ctx.beginPath(); ctx.arc(f.x,f.y,f.r,0,Math.PI*2); ctx.fill(); });
    blueClouds.forEach(b=>{ ctx.fillStyle='rgba(140,200,255,0.7)'; ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill(); });

    // Muminki
    mumins.forEach(m=>{
      if(!m.alive) return;
      ctx.save(); ctx.translate(m.x,m.y);
      const body = (m.frozen>0)? 'rgba(220,240,255,0.9)' : (m.hide ? 'rgba(255,255,255,0.75)' : '#f7f7f7');
      ctx.fillStyle=body;
      ctx.beginPath(); ctx.ellipse(0,4,8,11,0,0,Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.ellipse(0,-10,6,5,0,0,Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.ellipse(-3,-15,2,3,0,0,Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.ellipse(3,-15,2,3,0,0,Math.PI*2); ctx.fill();
      ctx.restore();
    });

    // Ogniki Włóczykija
    projs.forEach(p=>{ ctx.fillStyle='#a9ffbf'; ctx.beginPath(); ctx.arc(p.x,p.y,3,0,Math.PI*2); ctx.fill(); });

    // Pioruny mrozu
    iceBolts.forEach(b=>{
      ctx.strokeStyle='rgba(160,220,255,0.9)';
      ctx.beginPath(); ctx.moveTo(b.x-3,b.y); ctx.lineTo(b.x+3,b.y); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(b.x,b.y-3); ctx.lineTo(b.x,b.y+3); ctx.stroke();
    });

    // Włóczykij
    ctx.save(); ctx.translate(hunter.x,hunter.y);
    const frozen=hunter.frozen>0;
    ctx.fillStyle=frozen ? 'rgba(160,240,220,0.85)' : '#6ef0a7';
    ctx.beginPath(); ctx.moveTo(-10,-6); ctx.lineTo(10,-6); ctx.lineTo(0,-18); ctx.closePath(); ctx.fill();
    ctx.beginPath(); ctx.ellipse(0,5,10,12,0,0,Math.PI*2); ctx.fill();
    if(frozen){ ctx.strokeStyle='rgba(180,255,255,0.8)'; ctx.strokeRect(-12,-20,24,40); }
    ctx.restore();

    // Buka
    const glow=10+6*Math.sin(performance.now()/180);
    ctx.save(); ctx.translate(boka.x,boka.y);
    ctx.shadowColor='#7ad1ff'; ctx.shadowBlur=glow;
    ctx.fillStyle=boka.cloudActive?'#5aa7d4':'#7ad1ff';
    ctx.beginPath(); ctx.ellipse(0,2,boka.r*0.93,boka.r*1.3,0,0,Math.PI*2); ctx.fill();
    ctx.fillStyle=boka.cloudActive?'rgba(120,160,190,0.5)':'rgba(170,220,255,0.5)';
    ctx.beginPath(); ctx.ellipse(0,8,boka.r*1.1,6,0,0,Math.PI*2); ctx.fill();
    ctx.shadowBlur=0;
    // oczy
    const el=Math.hypot(boka.lookX,boka.lookY)||1; const ex=(boka.lookX/el)*2.2, ey=(boka.lookY/el)*2.2;
    ctx.fillStyle='#eef9ff';
    ctx.beginPath(); ctx.ellipse(-4,-4,3,4,0,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.ellipse(4,-4,3,4,0,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#0b1c10'; ctx.beginPath(); ctx.arc(-4+ex,-4+ey,1.6,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(4+ex,-4+ey,1.6,0,Math.PI*2); ctx.fill();
    ctx.restore();

    // Chmura mrozu
    if(boka.cloudActive){
      const radius=CLOUD_MAX_RADIUS*(boka.cloud/CLOUD_DURATION);
      const grd=ctx.createRadialGradient(boka.x,boka.y,10,boka.x,boka.y,radius);
      grd.addColorStop(0,'rgba(0,0,0,0.8)');
      grd.addColorStop(0.6,'rgba(0,0,0,0.6)');
      grd.addColorStop(1,'rgba(0,0,0,0)');
      ctx.fillStyle=grd; ctx.beginPath(); ctx.arc(boka.x,boka.y,radius,0,Math.PI*2); ctx.fill();
      ctx.strokeStyle='rgba(140,200,255,0.35)'; ctx.beginPath(); ctx.arc(boka.x,boka.y,Math.max(0,radius-6),0,Math.PI*2); ctx.stroke();
    }

    // ramka
    ctx.strokeStyle='rgba(255,255,255,0.06)'; ctx.strokeRect(0.5,0.5,canvas.width-1,canvas.height-1);
  }

  function startGame(reset=false){
    overlay.hidden=true;
    if(reset){ level=1; score=0; boka.ammoAlt=100; boka.ammoCloud=5; }
    else { boka.ammoAlt=100; boka.ammoCloud=5; }
    ammoAltText.textContent=boka.ammoAlt;
    ammoCloudText.textContent=boka.ammoCloud;
    cloudStockFill.style.width = Math.min(100, (boka.ammoCloud/10)*100) + '%';
    resetLevel();
    playing=true; paused=false;
    lastTick=performance.now();
    if(musicOn){ musicHappy.currentTime=0; musicHappy.play(); musicDark.pause(); }
    requestAnimationFrame(update);
  }

  function varColor(name,fallback){return getComputedStyle(document.documentElement).getPropertyValue(name)||fallback}
  overlay.hidden=false;
})();
</script>
</body>
</html>
