<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>BUKA w Dolinie Muminków</title>
<style>
  :root{
    --cell: 32px; --cols: 25; --rows: 18;
    --bg:#0b1c10; --path:#0f2a18; --wall:#23402a;
    --buka:#7ad1ff; --mumin:#f4f6f8; --hunter:#6ef0a7;
  }
  html,body{margin:0;height:100%;background:var(--bg);color:#e6ffe6;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial,sans-serif}
  .wrap{min-height:100%;display:grid;place-items:center;gap:10px;padding:10px}
  h1{margin:6px 0 2px;font-size:20px}
  .hud{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .badge{background:#173a24;border:1px solid #2a5b3c;padding:6px 10px;border-radius:8px}
  .meter{position:relative;width:160px;height:14px;background:#113621;border:1px solid #2a5b3c;border-radius:6px;overflow:hidden}
  .meter>.fill{position:absolute;inset:0;width:0%;background:linear-gradient(90deg,#3fd0ff,#6ec2ff)}
  .meter.hp>.fill{background:linear-gradient(90deg,#36d17c,#8fffd0)}
  .meter.cloud>.fill{background:linear-gradient(90deg,#000,#333)}
  .grid{position:relative;width:calc(var(--cell)*var(--cols));height:calc(var(--cell)*var(--rows));background:var(--path);border-radius:10px;overflow:hidden;box-shadow:0 0 0 3px #163c25 inset,0 10px 30px rgba(0,0,0,.35)}
  canvas{width:100%;height:100%;image-rendering:pixelated}
  .controls{opacity:.85;font-size:14px}
  .controls kbd{background:#113621;border:1px solid #215035;border-bottom-width:3px;padding:2px 6px;border-radius:5px;font-family:ui-monospace,Menlo,monospace}
  .overlay{position:absolute;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.55);color:white;text-align:center;padding:24px;backdrop-filter:blur(2px)}
  .overlay[hidden]{display:none !important;pointer-events:none}
  .overlay .card{background:rgba(16,40,28,.9);border:1px solid #2a5b3c;border-radius:12px;padding:18px 20px;max-width:560px}
  button{background:#2a5b3c;color:white;border:0;padding:10px 14px;border-radius:8px;font-weight:700;cursor:pointer;margin-top:10px}
  button:hover{filter:brightness(1.1)}
  .mute{background:#20543a}
</style>
</head>
<body>
<div class="wrap">
  <h1>BUKA w Dolinie Muminków</h1>
  <div class="hud">
    <div class="badge">Muminki: <span id="left">0</span></div>
    <div class="badge">Punkty: <span id="score">0</span></div>
    <div class="badge">Poziom: <span id="level">1</span></div>
    <div class="badge">Mróz Włóczykija: <span id="freezeT">0s</span></div>
    <div class="badge">Amunicja: <span id="ammoText">0</span></div>
    <div class="meter hp" title="Życie"><div id="hpFill" class="fill" style="width:100%"></div></div>
    <div class="meter cloud" title="Czas chmury"><div id="cloudFill" class="fill" style="width:0%"></div></div>
    <button id="musicBtn" class="mute" title="Włącz/wyłącz muzykę">Muzyka: ON</button>
    <div class="controls">Sterowanie: <kbd>WASD</kbd>/<kbd>Strzałki</kbd>, chmura: <kbd>Spacja</kbd>, piorun: <kbd>Alt</kbd>, pauza: <kbd>P</kbd>, restart: <kbd>R</kbd></div>
  </div>
  <div class="grid">
    <canvas id="game" width="800" height="576"></canvas>
    <div id="overlay" class="overlay">
      <div class="card">
        <div id="title" style="font-size:22px;margin-bottom:6px;">Buka budzi mróz…</div>
        <div id="desc" style="opacity:.9;margin-bottom:10px;">
          Spacja – chmura na 7 s (promień ~1/5 planszy), unieruchamia cię na 3 s i mrozi Muminki na 10 s, byś mógł je zjeść. Alt – wystrzał pioruna mrozu (mrozi cel na 10 s).
        </div>
        <button id="startBtn">Start</button>
      </div>
    </div>
  </div>
</div>

<!-- Muzyka: podmień src na własne pliki jeśli chcesz -->
<audio id="musicHappy" loop preload="auto" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_d0b2a58b8a.mp3?filename=happy-day-112194.mp3"></audio>
<audio id="musicDark" loop preload="auto" src="https://cdn.pixabay.com/download/audio/2021/12/20/audio_8e2b2e6fa2.mp3?filename=dark-ambient-110011.mp3"></audio>

<script>
(() => {
  // Parametry
  const CELL=32, COLS=25, ROWS=18;
  const WALL_DENSITY=0.25;
  const RNG_SEED=4242;

  const BOKA_SPEED=3.1, BOKA_R=14;
  const HUNTER_SPEED=2.7, HUNTER_R=12, HUNTER_PROJ_SPEED=5.0, HUNTER_FIRE_COOLDOWN=1.8, HUNTER_AIM_RANGE=380;
  const MUMIN_R=11, MUMINS_BASE=7, MUMIN_FEAR_DROP_RATE=0.35;
  const CLOUD_DURATION=7.0, CLOUD_FREEZE_MUMIN=10.0, BOKA_ROOT_TIME=3.0;
  const HUNTER_FREEZE_TIME=60.0, FREEZE_TICKS_TO_KILL=10;
  const HP_MAX=100, PROJ_DMG_PER_SEC=14;

  const MIN_BOARD=Math.min(COLS*CELL, ROWS*CELL);
  const CLOUD_MAX_RADIUS=Math.floor(MIN_BOARD/5);

  // DOM
  const canvas=document.getElementById('game');
  const ctx=canvas.getContext('2d');
  const overlay=document.getElementById('overlay');
  const startBtn=document.getElementById('startBtn');
  const leftEl=document.getElementById('left');
  const lvlEl=document.getElementById('level');
  const scoreEl=document.getElementById('score');
  const hpFill=document.getElementById('hpFill');
  const cloudFill=document.getElementById('cloudFill');
  const ammoText=document.getElementById('ammoText');
  const freezeT=document.getElementById('freezeT');
  const musicBtn=document.getElementById('musicBtn');
  const musicHappy=document.getElementById('musicHappy');
  const musicDark=document.getElementById('musicDark');

  // RNG
  function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return((t^t>>>14)>>>0)/4294967296}}
  let rng=mulberry32(RNG_SEED);

  // Mapa
  let grid=[];
  function isWall(c,r){if(r<0||c<0||r>=ROWS||c>=COLS)return true;return grid[r][c]===1}
  function genMap(level){
    rng=mulberry32(RNG_SEED+level*97);
    grid=Array.from({length:ROWS},()=>Array(COLS).fill(0));
    for(let r=0;r<ROWS;r++) for(let c=0;c<COLS;c++) if(r===0||c===0||r===ROWS-1||c===COLS-1) grid[r][c]=1;
    for(let r=1;r<ROWS-1;r++) for(let c=1;c<COLS-1;c++) if(rng()<WALL_DENSITY) grid[r][c]=1;
    let snakes=8;
    while(snakes--){
      let r=(ROWS>>1)+Math.floor((rng()-0.5)*6);
      let c=(COLS>>1)+Math.floor((rng()-0.5)*6);
      for(let i=0;i<200;i++){
        grid[r][c]=0;
        const d=Math.floor(rng()*4);
        if(d===0&&r>1)r--; if(d===1&&r<ROWS-2)r++;
        if(d===2&&c>1)c--; if(d===3&&c<COLS-2)c++;
      }
    }
    // Domek 3x3
    let dr=0,dc=0;
    for(let tries=0;tries<200;tries++){
      const r=2+Math.floor(rng()*(ROWS-5));
      const c=2+Math.floor(rng()*(COLS-5));
      let ok=true;
      for(let rr=r;rr<r+3;rr++) for(let cc=c;cc<c+3;cc++) if(isWall(cc,rr)) ok=false;
      if(ok){dr=r;dc=c;break;}
    }
    for(let rr=dr;rr<dr+3;rr++) for(let cc=dc;cc<dc+3;cc++) grid[rr][cc]=2;
    grid[1][1]=0;
  }
  function inHouse(x,y){const c=Math.floor(x/CELL), r=Math.floor(y/CELL); return grid[r] && grid[r][c]===2;}

  // Obiekty
  const boka={x:CELL*1.5,y:CELL*1.5,r:BOKA_R,hp:HP_MAX,poison:0, ammo:5, cloud:0, cloudActive:false, cloudFade:0, lookX:1, lookY:0, rooted:0};
  const hunter={x:CELL*(COLS-2.5), y:CELL*(ROWS-2.5), r:HUNTER_R, frozen:0, freezeHits:0, tShot:0};
  const mumins=[];
  const fearClouds=[], blueClouds=[];
  const projs=[];           // ogniki Włóczykija
  const iceBolts=[];        // pioruny mrozu Buki
  const crystals=[];        // kryształy amunicji
  let level=1, score=0;
  let playing=false, paused=false;
  let lastTick=0, musicOn=true;

  // Helpers
  function cellRect(c,r){return [c*CELL,r*CELL,CELL,CELL]}
  function dist(a,b,x,y){const dx=a-x,dy=b-y;return Math.hypot(dx,dy)}
  function moveCircle(obj,vx,vy,rad){
    let nx=obj.x+vx, ny=obj.y+vy;
    const minX=rad, minY=rad, maxX=COLS*CELL-rad, maxY=ROWS*CELL-rad;
    nx=Math.max(minX,Math.min(maxX,nx)); ny=Math.max(minY,Math.min(maxY,ny));
    const c=Math.floor(nx/CELL), r=Math.floor(ny/CELL);
    for(let rr=r-1;rr<=r+1;rr++) for(let cc=c-1;cc<=c+1;cc++){
      if(!isWall(cc,rr)) continue;
      const rx=cc*CELL, ry=rr*CELL;
      const cx=Math.max(rx,Math.min(nx,rx+CELL));
      const cy=Math.max(ry,Math.min(ny,ry+CELL));
      const dx=nx-cx, dy=ny-cy, d2=dx*dx+dy*dy;
      if(d2<rad*rad-1){
        const d=Math.sqrt(Math.max(d2,1e-4));
        const ux=dx/d, uy=dy/d;
        nx=cx+ux*(rad+0.5); ny=cy+uy*(rad+0.5);
      }
    }
    return {x:nx,y:ny};
  }

  function resetLevel(){
    genMap(level);
    mumins.length=0; fearClouds.length=0; blueClouds.length=0; projs.length=0; iceBolts.length=0; crystals.length=0;
    boka.x=CELL*1.5; boka.y=CELL*1.5; boka.hp=HP_MAX; boka.poison=0; boka.cloud=0; boka.cloudActive=false; boka.cloudFade=0; boka.lookX=1; boka.lookY=0; boka.rooted=0;
    hunter.x=CELL*(COLS-2.5); hunter.y=CELL*(ROWS-2.5); hunter.frozen=0; hunter.tShot=0;

    // Muminki
    const toPlace=MUMINS_BASE+Math.floor(level*1.5);
    let i=0;
    while(i<toPlace){
      const c=1+Math.floor(Math.random()*(COLS-2));
      const r=1+Math.floor(Math.random()*(ROWS-2));
      if(isWall(c,r)||grid[r][c]===2) continue;
      const x=c*CELL+CELL/2, y=r*CELL+CELL/2;
      if(dist(x,y,boka.x,boka.y)<60) continue;
      mumins.push({x,y,r:MUMIN_R, alive:true, hide:false, frozen:0, dir:Math.random()*Math.PI*2});
      i++;
    }
    // 5 kryształów amunicji
    let k=0;
    while(k<5){
      const c=1+Math.floor(Math.random()*(COLS-2));
      const r=1+Math.floor(Math.random()*(ROWS-2));
      if(isWall(c,r)||grid[r][c]===2) continue;
      const x=c*CELL+CELL/2, y=r*CELL+CELL/2;
      if(crystals.some(q=>dist(q.x,q.y,x,y)<20)) continue;
      crystals.push({x,y,r:9});
      k++;
    }

    leftEl.textContent = mumins.filter(m=>m.alive).length;
    lvlEl.textContent = level;
    scoreEl.textContent = score;
    ammoText.textContent = boka.ammo;
  }

  // Wejście
  const keys=new Set();
  window.addEventListener('keydown', (e)=>{
    const mv=['ArrowUp','ArrowDown','ArrowLeft','ArrowRight','KeyW','KeyA','KeyS','KeyD'];
    if(mv.includes(e.code)){ e.preventDefault(); keys.add(e.code); }
    if(e.code==='Space'){ e.preventDefault(); tryUseCloud(); }
    if(e.code==='AltLeft' || e.code==='AltRight'){ e.preventDefault(); fireIceBolt(); }
    if(e.code==='KeyP') paused=!paused;
    if(e.code==='KeyR') startGame(true);
  });
  window.addEventListener('keyup',(e)=>keys.delete(e.code));
  startBtn.addEventListener('click',()=>startGame());
  musicBtn.addEventListener('click',()=>{
    musicOn=!musicOn;
    musicBtn.textContent='Muzyka: '+(musicOn?'ON':'OFF');
    if(!musicOn){ musicHappy.pause(); musicDark.pause(); }
    else { if(boka.cloudActive) {musicDark.play(); musicHappy.pause();} else {musicHappy.play(); musicDark.pause();} }
  });

  function tryUseCloud(){
    if(boka.cloudActive) return;
    if(boka.ammo<=0) return;
    boka.ammo--; ammoText.textContent=boka.ammo;
    boka.cloud=CLOUD_DURATION;
    boka.cloudFade=1.0;
    boka.cloudActive=true;
    boka.rooted = BOKA_ROOT_TIME; // 3 s brak ruchu
    if(musicOn){ musicDark.currentTime=0; musicDark.play(); musicHappy.pause(); }
    // zamroź w zasięgu muminki na 10 s
    mumins.forEach(m=>{
      if(m.alive && dist(m.x,m.y,boka.x,boka.y) < CLOUD_MAX_RADIUS){
        m.frozen = Math.max(m.frozen, CLOUD_FREEZE_MUMIN);
      }
    });
    // zamroź Włóczykija
    if(dist(hunter.x,hunter.y,boka.x,boka.y) < CLOUD_MAX_RADIUS){
      if(hunter.frozen<=0) hunter.freezeHits++;
      hunter.frozen = Math.max(hunter.frozen, HUNTER_FREEZE_TIME);
    }
  }

  function fireIceBolt(){
    if(boka.ammo<=0) return;
    // pocisk w kierunku patrzenia
    const dirLen=Math.hypot(boka.lookX,boka.lookY)||1;
    const ux=boka.lookX/dirLen, uy=boka.lookY/dirLen;
    boka.ammo--; ammoText.textContent=boka.ammo;
    iceBolts.push({x:boka.x+ux*16, y:boka.y+uy*16, vx:ux*7.5, vy:uy*7.5, ttl:2.5});
  }

  function update(now){
    if(!playing) return;
    const dt=Math.min(0.033,(now-lastTick)/16.666);
    lastTick=now;
    if(paused){ draw(); requestAnimationFrame(update); return; }

    // Buka ruch
    if(boka.rooted>0){ boka.rooted-=dt; }
    if(!boka.cloudActive){
      // muzyka wesoła
      if(musicOn && musicDark.currentTime>0 && !musicDark.paused){ musicDark.pause(); musicHappy.play(); }
    }
    if(boka.cloudActive){
      boka.cloud -= dt; boka.cloudFade = Math.max(0, boka.cloud / CLOUD_DURATION);
      cloudFill.style.width = (boka.cloudFade*100)+'%';
      if(boka.cloud<=0){ boka.cloudActive=false; boka.cloudFade=0; cloudFill.style.width='0%'; if(musicOn){ musicDark.pause(); musicHappy.play(); } }
    }
    if(!boka.cloudActive && boka.rooted<=0){
      let ax=0,ay=0;
      if(keys.has('ArrowUp')||keys.has('KeyW')) ay-=1;
      if(keys.has('ArrowDown')||keys.has('KeyS')) ay+=1;
      if(keys.has('ArrowLeft')||keys.has('KeyA')) ax-=1;
      if(keys.has('ArrowRight')||keys.has('KeyD')) ax+=1;
      if(ax||ay){ const l=Math.hypot(ax,ay); ax/=l; ay/=l; boka.lookX=ax; boka.lookY=ay; }
      const sp=BOKA_SPEED*CELL/10;
      const moved=moveCircle(boka, ax*sp*dt, ay*sp*dt, BOKA_R);
      boka.x=moved.x; boka.y=moved.y;
    }

    // trucizna
    if(boka.poison>0){ boka.hp -= PROJ_DMG_PER_SEC*dt; boka.poison = Math.max(0,boka.poison-dt); }

    // Hunter
    if(hunter.frozen>0){ hunter.frozen-=dt; } else {
      const dx=boka.x-hunter.x, dy=boka.y-hunter.y, d=Math.hypot(dx,dy);
      if(d>1){ const ux=dx/d, uy=dy/d; const moved=moveCircle(hunter, ux*HUNTER_SPEED, uy*HUNTER_SPEED, HUNTER_R); hunter.x=moved.x; hunter.y=moved.y; }
      hunter.tShot-=dt;
      if(hunter.tShot<=0 && d<HUNTER_AIM_RANGE && !(boka.cloudActive && boka.rooted>0)){
        const speed=HUNTER_PROJ_SPEED;
        projs.push({x:hunter.x,y:hunter.y, vx:(dx/d)*speed, vy:(dy/d)*speed, ttl:5});
        hunter.tShot=HUNTER_FIRE_COOLDOWN*(0.9+Math.random()*0.4);
      }
    }

    // Ogniki
    for(let i=projs.length-1;i>=0;i--){
      const p=projs[i];
      p.ttl-=dt; if(p.ttl<=0){projs.splice(i,1); continue;}
      const moved=moveCircle(p, p.vx, p.vy, 2);
      p.x=moved.x; p.y=moved.y;
      if(dist(p.x,p.y,boka.x,boka.y)<BOKA_R+4){ boka.poison=2.5; projs.splice(i,1); }
    }

    // Pioruny mrozu
    for(let i=iceBolts.length-1;i>=0;i--){
      const b=iceBolts[i];
      b.ttl-=dt; if(b.ttl<=0){iceBolts.splice(i,1); continue;}
      const moved=moveCircle(b, b.vx, b.vy, 2);
      b.x=moved.x; b.y=moved.y;
      // mrożenie muminka
      for(const m of mumins){
        if(!m.alive) continue;
        if(dist(b.x,b.y,m.x,m.y)<m.r+4){ m.frozen = Math.max(m.frozen, CLOUD_FREEZE_MUMIN); b.ttl=0; break; }
      }
      // mrożenie Włóczykija
      if(dist(b.x,b.y,hunter.x,hunter.y)<HUNTER_R+4){
        if(hunter.frozen<=0) hunter.freezeHits++;
        hunter.frozen=Math.max(hunter.frozen, HUNTER_FREEZE_TIME);
        b.ttl=0;
      }
    }

    // Muminki
    mumins.forEach(m=>{
      if(!m.alive) return;
      if(m.frozen>0){ m.frozen-=dt; }
      else{
        // widoczność
        const dx=boka.x-m.x, dy=boka.y-m.y, d=Math.hypot(dx,dy);
        let see=false;
        if(d<260){
          const steps=Math.ceil(d/8); let ok=true;
          for(let k=1;k<steps;k++){ const xx=m.x+dx*(k/steps), yy=m.y+dy*(k/steps); const c=Math.floor(xx/CELL), r=Math.floor(yy/CELL); if(isWall(c,r)){ok=false;break;} }
          see=ok;
        }
        if(see){ // uciekaj do domku
          m.hide=true;
          let target=null, best=1e9;
          for(let r=0;r<ROWS;r++) for(let c=0;c<COLS;c++) if(grid[r][c]===2){
            const tx=c*CELL+CELL/2, ty=r*CELL+CELL/2; const dd=dist(m.x,m.y,tx,ty);
            if(dd<best){best=dd; target={x:tx,y:ty}}
          }
          if(target){ const ux=(target.x-m.x)/best, uy=(target.y-m.y)/best; const moved=moveCircle(m, ux*2.3, uy*2.3, MUMIN_R); m.x=moved.x; m.y=moved.y; }
          // chmurki strachu
          if(Math.random()<MUMIN_FEAR_DROP_RATE*dt*3){ fearClouds.push({x:m.x,y:m.y,r:8, ttl:10}); }
        } else {
          m.hide=false;
          if(Math.random()<0.02) m.dir=Math.random()*Math.PI*2;
          const moved=moveCircle(m, Math.cos(m.dir)*1.0, Math.sin(m.dir)*1.0, MUMIN_R); m.x=moved.x; m.y=moved.y;
        }
      }
      // Zjedzenie przez najazd (jeśli nie w domku i nie zamrożony? można zjeść także zamrożonego)
      if(dist(m.x,m.y,boka.x,boka.y) < BOKA_R+m.r && !inHouse(m.x,m.y)){
        m.alive=false;
        score+=50; scoreEl.textContent=score;
        boka.ammo += 3; ammoText.textContent=boka.ammo;
        blueClouds.push({x:m.x,y:m.y,r:10, ttl:15});
      }
    });

    // Kryształy amunicji
    for(let i=crystals.length-1;i>=0;i--){
      const c=crystals[i];
      if(dist(c.x,c.y,boka.x,boka.y) < BOKA_R+c.r){
        boka.ammo++; ammoText.textContent=boka.ammo;
        crystals.splice(i,1);
      }
    }

    // Zbieranie chmurek
    for(let i=fearClouds.length-1;i>=0;i--){
      const f=fearClouds[i]; f.ttl-=dt; if(f.ttl<=0){fearClouds.splice(i,1); continue;}
      if(dist(f.x,f.y,boka.x,boka.y)<BOKA_R+f.r){
        score+=10; scoreEl.textContent=score;
        boka.hp=Math.min(HP_MAX, boka.hp+5);
        fearClouds.splice(i,1);
      }
    }
    for(let i=blueClouds.length-1;i>=0;i--){
      const b=blueClouds[i]; b.ttl-=dt; if(b.ttl<=0){blueClouds.splice(i,1); continue;}
      if(dist(b.x,b.y,boka.x,boka.y)<BOKA_R+b.r){
        boka.hp=Math.min(HP_MAX, boka.hp+20);
        // dodatkowy ładunek
        boka.ammo += 1; ammoText.textContent=boka.ammo;
        blueClouds.splice(i,1);
      }
    }

    // Włóczykij stan
    if(hunter.freezeHits>=FREEZE_TICKS_TO_KILL){
      score+=500; level++;
      overlay.hidden=false;
      document.getElementById('title').textContent='Włóczykij pokonany';
      document.getElementById('desc').textContent='Zamrożony 10 razy! Start kolejnego poziomu?';
      playing=false; return;
    }

    // UI
    leftEl.textContent = mumins.filter(m=>m.alive).length;
    hpFill.style.width = Math.max(0, Math.min(100, (boka.hp/HP_MAX)*100))+'%';
    freezeT.textContent = (hunter.frozen>0? Math.ceil(hunter.frozen)+'s':'0s');

    if(boka.hp<=0){
      playing=false; overlay.hidden=false;
      document.getElementById('title').textContent='Przegrałeś…';
      document.getElementById('desc').textContent='Ogniki Włóczykija cię wyczerpały. Spróbuj ponownie.';
      return;
    }

    draw();
    requestAnimationFrame(update);
  }

  // Rysowanie
  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    // Tło (ciemniejsze gdy chmura aktywna)
    const darkShift = (boka.cloudActive? 0.12:0);
    for(let r=0;r<ROWS;r++) for(let c=0;c<COLS;c++){
      const [x,y,w,h]=cellRect(c,r);
      const t=grid[r][c];
      let col = t===1 ? '#23402a' : (t===2 ? '#163c25' : '#0f2a18');
      if(darkShift>0){
        // przyciemnij
        const k=(t===1?0.8:0.7); ctx.fillStyle=`rgba(10,20,14,${darkShift})`; 
      }
      ctx.fillStyle = (t===1 ? '#23402a' : (t===2 ? '#163c25' : '#0f2a18'));
      if(boka.cloudActive){ ctx.fillStyle = (t===1 ? '#1f3527' : (t===2 ? '#112a1d' : '#0b1d12')); }
      ctx.fillRect(x,y,w,h);
      if(t===1){ ctx.fillStyle='rgba(25,70,45,0.25)'; if(boka.cloudActive) ctx.fillStyle='rgba(20,55,38,0.25)'; ctx.fillRect(x+2,y+2,w-4,h-4); }
      if(t===2){ ctx.strokeStyle=boka.cloudActive?'rgba(90,140,120,0.35)':'rgba(120,200,160,0.4)'; ctx.strokeRect(x+3,y+3,w-6,h-6); }
    }

    // Kryształy
    crystals.forEach(c=>{
      const g=ctx.createRadialGradient(c.x,c.y,2,c.x,c.y,10);
      g.addColorStop(0,'#9ff'); g.addColorStop(1,'#39a');
      ctx.fillStyle=g; ctx.beginPath(); ctx.moveTo(c.x,c.y-9); ctx.lineTo(c.x+7,c.y+5); ctx.lineTo(c.x-7,c.y+5); ctx.closePath(); ctx.fill();
      ctx.strokeStyle='rgba(200,240,255,0.8)'; ctx.stroke();
    });

    // Chmurki
    fearClouds.forEach(f=>{ ctx.fillStyle='rgba(255,230,120,0.55)'; ctx.beginPath(); ctx.arc(f.x,f.y,f.r,0,Math.PI*2); ctx.fill(); });
    blueClouds.forEach(b=>{ ctx.fillStyle='rgba(140,200,255,0.7)'; ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill(); });

    // Muminki
    mumins.forEach(m=>{
      if(!m.alive) return;
      ctx.save(); ctx.translate(m.x,m.y);
      const body = (m.frozen>0)? 'rgba(220,240,255,0.9)' : (m.hide ? 'rgba(255,255,255,0.75)' : '#f7f7f7');
      ctx.fillStyle=body;
      ctx.beginPath(); ctx.ellipse(0,4,8,11,0,0,Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.ellipse(0,-10,6,5,0,0,Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.ellipse(-3,-15,2,3,0,0,Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.ellipse(3,-15,2,3,0,0,Math.PI*2); ctx.fill();
      ctx.strokeStyle='#cfd5da'; ctx.lineWidth=1; ctx.beginPath(); ctx.ellipse(0,4,8,11,0,0,Math.PI*2); ctx.stroke();
      ctx.restore();
    });

    // Ogniki
    projs.forEach(p=>{ ctx.fillStyle='#a9ffbf'; ctx.beginPath(); ctx.arc(p.x,p.y,3,0,Math.PI*2); ctx.fill(); });

    // Pioruny mrozu
    iceBolts.forEach(b=>{
      ctx.strokeStyle='rgba(160,220,255,0.9)';
      ctx.beginPath(); ctx.moveTo(b.x-3,b.y); ctx.lineTo(b.x+3,b.y); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(b.x,b.y-3); ctx.lineTo(b.x,b.y+3); ctx.stroke();
    });

    // Włóczykij
    ctx.save(); ctx.translate(hunter.x,hunter.y);
    const frozen=hunter.frozen>0;
    ctx.fillStyle=frozen ? 'rgba(160,240,220,0.85)' : '#6ef0a7';
    ctx.beginPath(); ctx.moveTo(-10,-6); ctx.lineTo(10,-6); ctx.lineTo(0,-18); ctx.closePath(); ctx.fill();
    ctx.beginPath(); ctx.ellipse(0,5,10,12,0,0,Math.PI*2); ctx.fill();
    if(frozen){ ctx.strokeStyle='rgba(180,255,255,0.8)'; ctx.strokeRect(-12,-20,24,40); }
    ctx.restore();

    // Buka
    const glow=10+6*Math.sin(performance.now()/180);
    ctx.save(); ctx.translate(boka.x,boka.y);
    ctx.shadowColor='#7ad1ff'; ctx.shadowBlur=glow;
    ctx.fillStyle=boka.cloudActive?'#5aa7d4':'#7ad1ff';
    ctx.beginPath(); ctx.ellipse(0,2,13,18,0,0,Math.PI*2); ctx.fill();
    ctx.fillStyle=boka.cloudActive?'rgba(120,160,190,0.5)':'rgba(170,220,255,0.5)';
    ctx.beginPath(); ctx.ellipse(0,8,16,6,0,0,Math.PI*2); ctx.fill();
    ctx.shadowBlur=0;
    // oczy kierunkowe
    const el=Math.hypot(boka.lookX,boka.lookY)||1; const ex=(boka.lookX/el)*2.2, ey=(boka.lookY/el)*2.2;
    ctx.fillStyle='#eef9ff';
    ctx.beginPath(); ctx.ellipse(-4,-4,3,4,0,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.ellipse(4,-4,3,4,0,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#0b1c10'; ctx.beginPath(); ctx.arc(-4+ex,-4+ey,1.6,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(4+ex,-4+ey,1.6,0,Math.PI*2); ctx.fill();
    ctx.restore();

    // Chmura mrozu
    if(boka.cloudActive){
      const radius=CLOUD_MAX_RADIUS*boka.cloudFade;
      const grd=ctx.createRadialGradient(boka.x,boka.y,10,boka.x,boka.y,radius);
      grd.addColorStop(0,'rgba(0,0,0,0.8)');
      grd.addColorStop(0.6,'rgba(0,0,0,0.6)');
      grd.addColorStop(1,'rgba(0,0,0,0)');
      ctx.fillStyle=grd; ctx.beginPath(); ctx.arc(boka.x,boka.y,radius,0,Math.PI*2); ctx.fill();
      ctx.strokeStyle='rgba(140,200,255,0.35)'; ctx.beginPath(); ctx.arc(boka.x,boka.y,Math.max(0,radius-6),0,Math.PI*2); ctx.stroke();
    }

    // ramka
    ctx.strokeStyle='rgba(255,255,255,0.06)'; ctx.strokeRect(0.5,0.5,canvas.width-1,canvas.height-1);
  }

  function startGame(reset=false){
    overlay.hidden=true;
    if(reset){ level=1; score=0; boka.ammo=5; }
    else { boka.ammo = 5; }
    ammoText.textContent=boka.ammo;
    resetLevel();
    playing=true; paused=false;
    lastTick=performance.now();
    if(musicOn){ musicHappy.currentTime=0; musicHappy.play(); musicDark.pause(); }
    requestAnimationFrame(update);
  }

  // Start
  overlay.hidden=false;
})();
</script>
</body>
</html>
