<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Krypto Dashboard – TradingView kafelki + ceny z CoinGecko</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#101832;
      --text:#e7ecff;
      --muted:#b7c3ff;
      --accent:#6aa9ff;
      --good:#27d980;
      --bad:#ff5c7a;
      --warn:#ffcc66;
      --border:rgba(255,255,255,0.08);
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial;
      color:var(--text);
      background:
        radial-gradient(60vw 60vw at 10% -10%, rgba(106,169,255,0.15), transparent 60%),
        radial-gradient(50vw 50vw at 110% 10%, rgba(255,92,122,0.12), transparent 60%),
        linear-gradient(180deg, #090d1a, #0b1020 30%, #0b1020 100%);
    }
    header{
      display:flex;align-items:center;justify-content:space-between;
      padding:18px 22px;border-bottom:1px solid var(--border);
      backdrop-filter: blur(8px);
      position:sticky;top:0;z-index:20;
      background: linear-gradient(180deg, rgba(16,24,50,0.75), rgba(16,24,50,0.45));
    }
    .brand{display:flex;gap:12px;align-items:center}
    .logo{
      width:38px;height:38px;border-radius:10px;
      background: conic-gradient(from 220deg, #6aa9ff, #8b6aff, #ff5c7a, #6aa9ff);
      box-shadow: inset 0 0 20px rgba(255,255,255,0.25), 0 8px 20px rgba(106,169,255,0.35);
      position:relative;
    }
    .logo:after{content:"";position:absolute;inset:5px;border-radius:8px;background:var(--panel);box-shadow: inset 0 0 12px rgba(0,0,0,0.45)}
    .brand h1{font-size:18px;margin:0;letter-spacing:0.4px}
    .muted{color:var(--muted)}
    .row{display:grid;grid-template-columns: 320px 1fr;gap:18px;padding:18px;align-items:start}
    aside{display:flex;flex-direction:column;gap:14px;position:sticky;top:76px;height:calc(100dvh - 90px);overflow:auto;padding-right:4px}
    .panel{
      background: linear-gradient(180deg, rgba(16,24,50,0.75), rgba(16,24,50,0.5));
      border:1px solid var(--border);border-radius:var(--radius);box-shadow: var(--shadow);padding:14px;
    }
    .panel h3{margin:0 0 10px 0;font-size:14px;color:var(--muted);font-weight:600;letter-spacing:0.5px}
    .btn{
      background:linear-gradient(180deg, #6aa9ff, #3b7be6);
      color:#071024;border:none;padding:10px 12px;border-radius:10px;font-weight:700;
      cursor:pointer;box-shadow: 0 6px 18px rgba(106,169,255,0.35);
      transition: transform .08s ease, box-shadow .2s ease; font-size:13px;
    }
    .btn.small{padding:6px 8px;font-size:12px;border-radius:8px}
    .btn:active{transform: translateY(1px); box-shadow: 0 3px 10px rgba(106,169,255,0.3)}
    .btn.alt{
      background:linear-gradient(180deg, #1e2b55, #142043);
      color:var(--text);border:1px solid var(--border); box-shadow:none; font-weight:600;
    }
    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
    .field label{font-size:12px;color:var(--muted)}
    .input, select, textarea{
      background:linear-gradient(180deg, #0c1430, #0b132a);
      border:1px solid var(--border);color:var(--text);
      padding:10px;border-radius:10px;outline:none;font-size:13px;
    }
    .kpis{display:grid;grid-template-columns: repeat(4, minmax(0,1fr)); gap:12px}
    .kpi{padding:12px;border-radius:12px;border:1px solid var(--border);background: linear-gradient(180deg, rgba(24,36,80,0.6), rgba(15,26,61,0.45))}
    .kpi .label{font-size:12px;color:var(--muted)}
    .kpi .value{font-size:18px;font-weight:800;margin-top:4px; display:block; line-height:1.2}
    .kpi .delta{font-size:12px;margin-top:6px; display:block; line-height:1.2}
    .good{color:var(--good)} .bad{color:var(--bad)} .warn{color:var(--warn)}
    .table{width:100%;border-collapse:separate;border-spacing:0;overflow:hidden;border-radius:12px;border:1px solid var(--border)}
    .table th, .table td{padding:10px;border-bottom:1px solid var(--border);font-size:13px;text-align:left}
    .table th{color:var(--muted);font-weight:600;background:rgba(16,24,50,0.55);backdrop-filter: blur(6px)}
    .table tr:nth-child(even) td{background:rgba(10,16,36,0.35)}
    .tabs{display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap}
    .tab{padding:8px 10px;border-radius:10px;border:1px solid var(--border);cursor:pointer;background:linear-gradient(180deg, #0c1430, #0b132a);color:var(--muted);font-size:12px}
    .tab.active{color:var(--text);border-color:#3856b7; box-shadow: inset 0 0 0 1px rgba(106,169,255,0.25)}
    footer{padding:18px;color:var(--muted);font-size:12px;text-align:center}

    .canvas{
      position:relative;border-radius:12px;border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(24,36,80,0.35), rgba(12,18,40,0.45));
      min-height: 520px;overflow:hidden;
    }
    .tile{
      position:absolute;background: radial-gradient(120% 120% at -10% -10%, rgba(106,169,255,0.12), transparent 40%), #0b1330;
      border:1px solid var(--border);border-radius:12px;box-shadow: var(--shadow);overflow:hidden;display:flex;flex-direction:column;
    }
    .tile.locked{box-shadow:none}
    .tile .toolbar{
      display:flex;align-items:center;justify-content:space-between;gap:8px;padding:8px;border-bottom:1px solid var(--border);
      background: linear-gradient(180deg, rgba(16,24,50,0.75), rgba(16,24,50,0.35));
      cursor: move;user-select:none;
    }
    .tile.locked .toolbar{cursor:default}
    .toolbar .title{font-size:12px;color:var(--muted)}
    .toolbar .actions{display:flex;gap:6px}
    .content{position:relative;flex:1;min-height:140px}
    .tv-holder{position:absolute;inset:0}
    .resizer{position:absolute;right:6px;bottom:6px;width:14px;height:14px;border-radius:4px;border:1px solid var(--border);
      background:linear-gradient(135deg, rgba(106,169,255,0.45), rgba(106,169,255,0.15));cursor: nwse-resize;opacity:0.85;
    }
    .locked .resizer{display:none}
    .statline{
      display:grid;grid-template-columns: 1fr repeat(3, max-content);gap:10px;
      align-items:center;padding:8px;border-top:1px solid var(--border);font-size:12px;background: rgba(10,16,36,0.35)
    }

    .two-col{display:grid;grid-template-columns: 1fr 1fr;gap:12px}
    @media (max-width: 1100px){
      .row{grid-template-columns: 1fr}
      aside{position:relative;height:auto}
      .kpis{grid-template-columns: repeat(2, minmax(0,1fr))}
      .canvas{min-height:420px}
      .two-col{grid-template-columns: 1fr}
    }
  </style>
  <script type="importmap">
    {
      "imports": {
        "uuid": "https://cdn.jsdelivr.net/npm/uuid@9.0.1/dist/esm-browser/index.js"
      }
    }
  </script>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>Krypto Dashboard</h1>
        <div class="muted" style="font-size:12px">Kafelki z wykresami TradingView. Ceny z CoinGecko (bez kluczy).</div>
      </div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <span id="status" class="muted" style="font-size:12px">Ładowanie...</span>
      <button id="addBtcTile" class="btn">Dodaj BTC</button>
    </div>
  </header>

  <div class="row">
    <aside>
      <div class="panel">
        <h3>Dodaj kafelek</h3>
        <div class="field"><label>Symbol (np. BTC, ETH)</label><input id="symbolInput" class="input" placeholder="BTC" /></div>
        <div class="two-col">
          <button id="addTile" class="btn">Dodaj wykres</button>
          <button id="autoLayout" class="btn alt">Auto-układ</button>
        </div>
        <div class="field" style="margin-top:8px">
          <label>Tryb kafelków</label>
          <select id="layoutMode" class="input">
            <option value="fit">Dopasuj do siatki</option>
            <option value="cascade">Kaskada</option>
          </select>
        </div>
        <div class="two-col" style="margin-top:8px">
          <button id="lockAll" class="btn alt">Zablokuj</button>
          <button id="clearAll" class="btn alt">Wyczyść</button>
        </div>
      </div>

      <div class="panel">
        <h3>Top ceny (z CoinGecko)</h3>
        <table class="table" id="pricesTable">
          <thead>
            <tr><th>Token</th><th>Cena</th><th>24h</th><th></th></tr>
          </thead>
          <tbody></tbody>
          <tfoot><tr><td colspan="4" class="muted" style="padding:10px">Brak danych</td></tr></tfoot>
        </table>
      </div>

      <div class="panel">
        <h3>KPIs</h3>
        <div class="kpis">
          <div class="kpi">
            <div class="label">Liczba kafelków</div>
            <div class="value" id="kpiTiles">0</div>
            <div class="delta muted">aktywnych wykresów</div>
          </div>
          <div class="kpi">
            <div class="label">Ostatnia aktualizacja</div>
            <div class="value" id="kpiUpdated">—</div>
            <div class="delta muted">ceny co 30s</div>
          </div>
          <div class="kpi">
            <div class="label">Źródło danych</div>
            <div class="value">CoinGecko</div>
            <div class="delta muted">bez API key</div>
          </div>
          <div class="kpi">
            <div class="label">Wykresy</div>
            <div class="value">TradingView</div>
            <div class="delta muted">widget</div>
          </div>
        </div>
      </div>
    </aside>

    <main style="display:flex;flex-direction:column;gap:18px">
      <section class="panel">
        <h3 style="margin-top:0">Płótno kafelków</h3>
        <div id="canvas" class="canvas"></div>
      </section>

      <section class="panel">
        <h3 style="margin-top:0">Szybkie dodawanie</h3>
        <div style="display:flex;flex-wrap:wrap;gap:8px">
          <button class="btn small" data-quick="BTC">BTC</button>
          <button class="btn small" data-quick="ETH">ETH</button>
          <button class="btn small" data-quick="SOL">SOL</button>
          <button class="btn small" data-quick="BNB">BNB</button>
          <button class="btn small" data-quick="XRP">XRP</button>
          <button class="btn small" data-quick="DOGE">DOGE</button>
          <button class="btn small" data-quick="ADA">ADA</button>
          <button class="btn small" data-quick="ARB">ARB</button>
          <button class="btn small" data-quick="APT">APT</button>
          <button class="btn small" data-quick="SUI">SUI</button>
        </div>
      </section>
    </main>
  </div>

  <footer>
    Wykresy są osadzane przez widget TradingView. Ceny pobierane z publicznego API CoinGecko. Brak zewnętrznych zasobów multimedialnych – wszystko działa lokalnie w przeglądarce.
  </footer>

  <script type="module">
    import { v4 as uuidv4 } from "uuid";

    // State
    const ui = {
      status: document.getElementById("status"),
      canvas: document.getElementById("canvas"),
      pricesTable: document.getElementById("pricesTable"),
      kpiTiles: document.getElementById("kpiTiles"),
      kpiUpdated: document.getElementById("kpiUpdated"),
      symbolInput: document.getElementById("symbolInput"),
      addTile: document.getElementById("addTile"),
      addBtcTile: document.getElementById("addBtcTile"),
      autoLayout: document.getElementById("autoLayout"),
      layoutMode: document.getElementById("layoutMode"),
      lockAll: document.getElementById("lockAll"),
      clearAll: document.getElementById("clearAll")
    };

    const defaultTileSize = { w: 360, h: 260 };
    let tiles = []; // {id,symbol,x,y,w,h,locked}
    let isLocked = false;

    // CoinGecko simple price IDs mapping
    const symbolToId = {
      BTC: "bitcoin", ETH:"ethereum", SOL:"solana", BNB:"binancecoin", XRP:"ripple",
      DOGE:"dogecoin", ADA:"cardano", ARB:"arbitrum", APT:"aptos", SUI:"sui"
    };
    const idToSymbol = Object.fromEntries(Object.entries(symbolToId).map(([k,v])=>[v,k]));

    // Fetch prices from CoinGecko
    async function fetchPrices(symbols){
      const ids = symbols
        .map(s=>symbolToId[s.toUpperCase()])
        .filter(Boolean);
      if(ids.length===0) return {};
      const url = `https://api.coingecko.com/api/v3/simple/price?ids=${encodeURIComponent(ids.join(','))}&vs_currencies=usd&include_24hr_change=true`;
      const r = await fetch(url, { headers: { "accept": "application/json" } });
      if(!r.ok) throw new Error("HTTP "+r.status);
      const json = await r.json();
      const out = {};
      for(const [id, obj] of Object.entries(json)){
        const sym = idToSymbol[id] || id.toUpperCase();
        out[sym] = { price: obj.usd, ch24: obj.usd_24h_change };
      }
      return out;
    }

    // Price cache and periodic refresh
    let priceCache = {};
    async function refreshPriceTable(){
      try{
        ui.status.textContent = "Aktualizuję ceny...";
        const syms = Object.keys(symbolToId);
        const data = await fetchPrices(syms);
        priceCache = {...priceCache, ...data};
        renderPrices(data);
        ui.kpiUpdated.textContent = new Date().toLocaleTimeString();
        ui.status.textContent = "OK";
      }catch(e){
        ui.status.textContent = "Błąd pobierania cen";
      }
    }
    function renderPrices(data){
      const tbody = ui.pricesTable.querySelector("tbody");
      const tfoot = ui.pricesTable.querySelector("tfoot");
      tbody.innerHTML = "";
      const entries = Object.keys(symbolToId).map(sym => ({ sym, ...data[sym] })).filter(x=>x.price!=null);
      if(entries.length===0){ tfoot.style.display=""; return; }
      tfoot.style.display="none";
      for(const row of entries){
        const tr = document.createElement("tr");
        const cls = row.ch24>0?"good": row.ch24<0?"bad":"muted";
        tr.innerHTML = `
          <td><strong>${row.sym}</strong></td>
          <td>$${Number(row.price).toLocaleString(undefined,{maximumFractionDigits:6})}</td>
          <td class="${cls}">${(row.ch24>=0?"+":"") + row.ch24.toFixed(2)}%</td>
          <td><button class="btn small alt" data-add="${row.sym}">Kafelek</button></td>
        `;
        tbody.appendChild(tr);
      }
      tbody.querySelectorAll("button[data-add]").forEach(b=>{
        b.addEventListener("click", ()=> addTile(b.dataset.add));
      });
    }

    // TradingView widget loader (no external assets other than script)
    function ensureTVScript(){
      return new Promise((resolve, reject)=>{
        if(window.TradingView?.widget){ resolve(); return; }
        const s = document.createElement("script");
        s.src = "https://s3.tradingview.com/tv.js";
        s.async = true;
        s.onload = ()=> resolve();
        s.onerror = ()=> reject(new Error("Nie udało się załadować TradingView"));
        document.head.appendChild(s);
      });
    }

    // Tile lifecycle
    function createTileEl(tile){
      const el = document.createElement("div");
      el.className = "tile" + ((isLocked || tile.locked) ? " locked" : "");
      Object.assign(el.style, {
        left: (tile.x||0)+"px",
        top: (tile.y||0)+"px",
        width: (tile.w||defaultTileSize.w)+"px",
        height: (tile.h||defaultTileSize.h)+"px"
      });
      el.dataset.id = tile.id;

      const toolbar = document.createElement("div");
      toolbar.className = "toolbar";
      const title = document.createElement("div");
      title.className = "title";
      const priceObj = priceCache[tile.symbol];
      const priceTxt = priceObj ? `$${Number(priceObj.price).toLocaleString(undefined,{maximumFractionDigits:6})}` : "—";
      title.textContent = `${tile.symbol} — ${priceTxt}`;
      const actions = document.createElement("div");
      actions.className = "actions";

      const btnDup = document.createElement("button");
      btnDup.className = "btn small alt"; btnDup.textContent = "Duplikuj";
      btnDup.addEventListener("click",(e)=>{ e.stopPropagation(); addTile(tile.symbol); });

      const btnLock = document.createElement("button");
      btnLock.className = "btn small"; btnLock.textContent = tile.locked ? "Odblokuj" : "Zablokuj";
      btnLock.addEventListener("click",(e)=>{ e.stopPropagation(); toggleLockTile(tile.id); });

      const btnDel = document.createElement("button");
      btnDel.className = "btn small alt"; btnDel.textContent = "Usuń";
      btnDel.addEventListener("click",(e)=>{ e.stopPropagation(); removeTile(tile.id); });

      actions.append(btnDup, btnLock, btnDel);
      toolbar.append(title, actions);

      const content = document.createElement("div");
      content.className = "content";
      const holder = document.createElement("div");
      holder.className = "tv-holder";
      holder.id = `tv_${tile.id}`;
      content.appendChild(holder);

      const stat = document.createElement("div");
      stat.className = "statline";
      const ch = priceObj?.ch24 ?? 0;
      const cls = ch>0?"good": ch<0?"bad":"muted";
      stat.innerHTML = `
        <div><strong>${tile.symbol}</strong></div>
        <div class="muted">Cena: <strong>${priceTxt}</strong></div>
        <div class="${cls}">24h: <strong>${(ch>=0?"+":"") + ch.toFixed(2)}%</strong></div>
        <div class="muted"></div>
      `;

      const res = document.createElement("div");
      res.className = "resizer";

      el.append(toolbar, content, res, stat);

      // drag
      if(!(isLocked || tile.locked)){
        let drag=null, resize=null;
        toolbar.addEventListener("pointerdown", (e)=>{
          el.setPointerCapture(e.pointerId);
          drag = { sx:e.clientX, sy:e.clientY, ox: tile.x||0, oy: tile.y||0 };
        });
        el.addEventListener("pointermove", (e)=>{
          if(drag){
            const nx = Math.max(0, drag.ox + (e.clientX - drag.sx));
            const ny = Math.max(0, drag.oy + (e.clientY - drag.sy));
            el.style.left = nx+"px"; el.style.top = ny+"px";
          }
          if(resize){
            const nw = Math.max(260, resize.ow + (e.clientX - resize.sx));
            const nh = Math.max(180, resize.oh + (e.clientY - resize.sy));
            el.style.width = nw+"px"; el.style.height = nh+"px";
          }
        });
        el.addEventListener("pointerup", ()=>{
          if(drag){
            const id = tile.id;
            const t = tiles.find(t=>t.id===id);
            t.x = parseInt(el.style.left); t.y = parseInt(el.style.top);
            drag = null;
          }
          if(resize){
            const id = tile.id;
            const t = tiles.find(t=>t.id===id);
            t.w = parseInt(el.style.width); t.h = parseInt(el.style.height);
            resize = null;
          }
        });
        res.addEventListener("pointerdown", (e)=>{
          e.stopPropagation();
          el.setPointerCapture(e.pointerId);
          resize = { sx:e.clientX, sy:e.clientY, ow: tile.w||defaultTileSize.w, oh: tile.h||defaultTileSize.h };
        });
      }

      // Render TradingView widget
      ensureTVScript().then(()=>{
        const sym = mapToTradingViewSymbol(tile.symbol);
        // Clean holder
        holder.innerHTML = "";
        // TradingView widget config
        new window.TradingView.widget({
          autosize: true,
          symbol: sym,
          interval: "60",
          timezone: "Etc/UTC",
          theme: "dark",
          style: "1",
          locale: "pl",
          toolbar_bg: "rgba(0,0,0,0)",
          hide_top_toolbar: true,
          hide_legend: true,
          allow_symbol_change: false,
          container_id: holder.id
        });
      }).catch(()=>{
        holder.innerHTML = "<div style='padding:10px' class='muted'>Błąd widgetu TradingView</div>";
      });

      return el;
    }

    function mapToTradingViewSymbol(sym){
      // Mapowanie popularnych par na Binance
      const map = {
        BTC: "BINANCE:BTCUSDT",
        ETH: "BINANCE:ETHUSDT",
        SOL: "BINANCE:SOLUSDT",
        BNB: "BINANCE:BNBUSDT",
        XRP: "BINANCE:XRPUSDT",
        DOGE: "BINANCE:DOGEUSDT",
        ADA: "BINANCE:ADAUSDT",
        ARB: "BINANCE:ARBUSDT",
        APT: "BINANCE:APTUSDT",
        SUI: "BINANCE:SUIUSDT"
      };
      return map[sym.toUpperCase()] || `BINANCE:${sym.toUpperCase()}USDT`;
    }

    function renderTiles(){
      ui.canvas.innerHTML = "";
      tiles.forEach(t => {
        const el = createTileEl(t);
        ui.canvas.appendChild(el);
      });
      ui.kpiTiles.textContent = String(tiles.length);
    }

    function addTile(symbol){
      const sym = (symbol || ui.symbolInput.value || "BTC").toUpperCase();
      const x = 16 + (tiles.length % 3) * (defaultTileSize.w + 16);
      const y = 16 + Math.floor(tiles.length / 3) * (defaultTileSize.h + 16);
      tiles.push({ id: uuidv4(), symbol: sym, x, y, w: defaultTileSize.w, h: defaultTileSize.h, locked: false });
      renderTiles();
    }
    function removeTile(id){
      tiles = tiles.filter(t=>t.id!==id);
      renderTiles();
    }
    function toggleLockTile(id){
      const t = tiles.find(t=>t.id===id);
      if(!t) return;
      t.locked = !t.locked;
      renderTiles();
    }
    function toggleLockAll(){
      isLocked = !isLocked;
      tiles.forEach(t=> t.locked = isLocked);
      renderTiles();
      ui.lockAll.textContent = isLocked ? "Odblokuj" : "Zablokuj";
    }

    function autoLayout(mode="fit"){
      const W = ui.canvas.clientWidth || 960;
      const gap = 16;
      const colW = defaultTileSize.w, rowH = defaultTileSize.h;
      let x=gap, y=gap, maxH=rowH;
      tiles.forEach((t, idx)=>{
        if(mode==="fit"){
          if(x + colW + gap > W){ x=gap; y+= maxH + gap; maxH=rowH; }
          t.x = x; t.y = y; t.w = colW; t.h = rowH; x += colW + gap;
        }else{
          t.x = gap + (idx*24)%Math.max(24, (W - colW - gap));
          t.y = gap + idx*28;
          t.w = colW; t.h = rowH;
        }
      });
      renderTiles();
    }

    // Events
    ui.addTile.addEventListener("click", ()=> addTile());
    ui.addBtcTile.addEventListener("click", ()=> addTile("BTC"));
    ui.autoLayout.addEventListener("click", ()=> autoLayout(ui.layoutMode.value));
    ui.lockAll.addEventListener("click", ()=> toggleLockAll());
    ui.clearAll.addEventListener("click", ()=> { tiles = []; renderTiles(); });

    document.querySelectorAll("[data-quick]").forEach(b=>{
      b.addEventListener("click", ()=> addTile(b.getAttribute("data-quick")));
    });

    // Init
    refreshPriceTable();
    renderTiles();
    setInterval(refreshPriceTable, 30000);
  </script>
</body>
</html>
