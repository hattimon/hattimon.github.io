<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8">
  <title>Twoja strona</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Chart.js + adapter czasu do osi X -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
</head>
<body>

  <!-- Audio: tylko zmiana źródła na bg.mp3 -->
  <audio id="bgmb3-audio" src="bg.mp3" preload="auto" loop></audio>

  <!-- Przycisk GII (pozostawiasz swój, jeśli już masz) -->
  <button id="bgmb3-toggle" aria-pressed="false">BG MB3: Off</button>

  <!-- Kontener na cenę (jeśli masz już swój, zostaw identyczny ID) -->
  <div>
    Cena HNT: <span id="hnt-price">--</span> USD
  </div>

  <!-- Canvas wykresu (jeśli masz już swój, zachowaj id="hnt-chart") -->
  <canvas id="hnt-chart" height="300"></canvas>

  <script>
    // Istniejące sterowanie audio – pozostawione bez zmian poza tym, że src to bg.mp3
    (function() {
      const audioEl = document.getElementById('bgmb3-audio');
      const toggleBtn = document.getElementById('bgmb3-toggle');
      const LS_KEY = 'bgmb3_enabled';

      let enabled = localStorage.getItem(LS_KEY);
      if (enabled === null) {
        enabled = '1';
        localStorage.setItem(LS_KEY, '1');
      }

      function setBtnState(on) {
        if (!toggleBtn) return;
        toggleBtn.setAttribute('aria-pressed', on ? 'true' : 'false');
        toggleBtn.textContent = `BG MB3: ${on ? 'On' : 'Off'}`;
      }

      async function startAudioIfEnabled() {
        if (enabled === '1') {
          try {
            await audioEl.play();
          } catch {
            const unlock = () => {
              audioEl.play().catch(() => {});
              window.removeEventListener('pointerdown', unlock);
              window.removeEventListener('keydown', unlock);
            };
            window.addEventListener('pointerdown', unlock, { once: true });
            window.addEventListener('keydown', unlock, { once: true });
          }
        } else {
          audioEl.pause();
          audioEl.currentTime = 0;
        }
        setBtnState(enabled === '1');
      }

      if (toggleBtn) {
        toggleBtn.addEventListener('click', async () => {
          enabled = (enabled === '1') ? '0' : '1';
          localStorage.setItem(LS_KEY, enabled);
          await startAudioIfEnabled();
        });
      }

      document.addEventListener('DOMContentLoaded', startAudioIfEnabled);
    })();
  </script>

  <script>
    // Wykres HNT + aktualizacja ceny z CoinGecko (pełna historia, dokładność)
    (function() {
      const priceEl = document.getElementById('hnt-price');
      const chartCanvas = document.getElementById('hnt-chart');

      const COINGECKO_PRICE = 'https://api.coingecko.com/api/v3/simple/price?ids=helium&vs_currencies=usd';
      const COINGECKO_HISTORY = 'https://api.coingecko.com/api/v3/coins/helium/market_chart?vs_currency=usd&days=max';

      let chart;

      function formatUSD(v) {
        if (v >= 1) return `$${v.toFixed(2)}`;
        if (v >= 0.01) return `$${v.toFixed(4)}`;
        return `$${v.toFixed(6)}`;
      }

      async function fetchJSON(url) {
        const res = await fetch(url, { cache: 'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return res.json();
      }

      async function updateSpotPrice() {
        try {
          const data = await fetchJSON(COINGECKO_PRICE);
          const price = data?.helium?.usd;
          if (typeof price === 'number' && priceEl) {
            priceEl.textContent = price.toFixed(price >= 1 ? 2 : (price >= 0.01 ? 4 : 6));
          }
        } catch {
          // ciche pominięcie
        }
      }

      function buildChart(labels, values) {
        if (!chartCanvas) return;
        if (chart) chart.destroy();
        chart = new Chart(chartCanvas.getContext('2d'), {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label: 'HNT/USD',
              data: values,
              borderColor: '#3b82f6',
              borderWidth: 2,
              pointRadius: 0,
              tension: 0.1
            }]
          },
          options: {
            parsing: false,
            animation: false,
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: {
                type: 'time',
                time: { tooltipFormat: 'yyyy-MM-dd HH:mm' },
                ticks: { maxRotation: 0, autoSkip: true }
              },
              y: {
                ticks: {
                  callback: v => formatUSD(Number(v)).replace('$', '')
                }
              }
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                intersect: false,
                callbacks: {
                  label: ctx => ` ${formatUSD(ctx.parsed.y)}`
                }
              }
            }
          }
        });
      }

      async function loadFullHistory() {
        const raw = await fetchJSON(COINGECKO_HISTORY);
        const prices = raw?.prices || [];
        const labels = prices.map(p => new Date(p[0]));
        const values = prices.map(p => p[1]);
        buildChart(labels, values);
      }

      function startPricePolling(intervalMs = 60000) {
        updateSpotPrice();
        setInterval(updateSpotPrice, intervalMs);
      }

      document.addEventListener('DOMContentLoaded', async () => {
        try { await loadFullHistory(); } catch {}
        startPricePolling(60000);
      });
    })();
  </script>
</body>
</html>
